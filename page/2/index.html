<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/page/2/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 5.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-centos7挂载新硬盘" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2018/10/14/centos7%E6%8C%82%E8%BD%BD%E6%96%B0%E7%A1%AC%E7%9B%98/" class="article-date">
  <time class="dt-published" datetime="2018-10-14T06:30:13.000Z" itemprop="datePublished">2018-10-14</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/linux/">linux</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2018/10/14/centos7%E6%8C%82%E8%BD%BD%E6%96%B0%E7%A1%AC%E7%9B%98/">centos7挂载新硬盘</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>目的是将一块新的硬盘挂载到系统中，暂且用4G的U盘挂到/outdata这个目录下</p>
<h1 id="原始状态"><a href="#原始状态" class="headerlink" title="原始状态"></a>原始状态</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# df -lh</span><br><span class="line">文件系统                 容量  已用  可用 已用% 挂载点</span><br><span class="line">/dev/mapper/centos-root   36G  <span class="number">1.</span>9G   34G    <span class="number">6</span>% /</span><br><span class="line">devtmpfs                 <span class="number">1.</span>9G     <span class="number">0</span>  <span class="number">1.</span>9G    <span class="number">0</span>% /dev</span><br><span class="line">tmpfs                    <span class="number">1.</span>9G     <span class="number">0</span>  <span class="number">1.</span>9G    <span class="number">0</span>% /dev/shm</span><br><span class="line">tmpfs                    <span class="number">1.</span>9G  <span class="number">8.</span>6M  <span class="number">1.</span>9G    <span class="number">1</span>% /run</span><br><span class="line">tmpfs                    <span class="number">1.</span>9G     <span class="number">0</span>  <span class="number">1.</span>9G    <span class="number">0</span>% /sys/fs/cgroup</span><br><span class="line">/dev/sda1               1014M  184M  831M   <span class="number">19</span>% /boot</span><br><span class="line">tmpfs                    380M     <span class="number">0</span>  380M    <span class="number">0</span>% /run/user/<span class="number">0</span></span><br><span class="line"></span><br><span class="line">[root@localhost ~]# fdisk -l</span><br><span class="line">磁盘 /dev/sda：<span class="number">42.9</span> GB, <span class="number">42949672960</span> 字节，<span class="number">83886080</span> 个扇区</span><br><span class="line">Units = 扇区 of <span class="number">1</span> * <span class="number">512</span> = <span class="number">512</span> bytes</span><br><span class="line">扇区大小(逻辑/物理)：<span class="number">512</span> 字节 / <span class="number">512</span> 字节</span><br><span class="line">I/O 大小(最小/最佳)：<span class="number">512</span> 字节 / <span class="number">512</span> 字节</span><br><span class="line">磁盘标签类型：dos</span><br><span class="line">磁盘标识符：<span class="number">0x000b9d39</span></span><br><span class="line">   设备 Boot      Start         End      Blocks   Id  System</span><br><span class="line">/dev/sda1   *        <span class="number">2048</span>     <span class="number">2099199</span>     <span class="number">1048576</span>   <span class="number">83</span>  Linux</span><br><span class="line">/dev/sda2         <span class="number">2099200</span>    <span class="number">83886079</span>    <span class="number">40893440</span>   8e  Linux LVM</span><br><span class="line"></span><br><span class="line">磁盘 /dev/mapper/centos-root：<span class="number">37.7</span> GB, <span class="number">37706792960</span> 字节，<span class="number">73646080</span> 个扇区</span><br><span class="line">Units = 扇区 of <span class="number">1</span> * <span class="number">512</span> = <span class="number">512</span> bytes</span><br><span class="line">扇区大小(逻辑/物理)：<span class="number">512</span> 字节 / <span class="number">512</span> 字节</span><br><span class="line">I/O 大小(最小/最佳)：<span class="number">512</span> 字节 / <span class="number">512</span> 字节</span><br><span class="line"></span><br><span class="line">磁盘 /dev/mapper/centos-swap：<span class="number">4160</span> MB, <span class="number">4160749568</span> 字节，<span class="number">8126464</span> 个扇区</span><br><span class="line">Units = 扇区 of <span class="number">1</span> * <span class="number">512</span> = <span class="number">512</span> bytes</span><br><span class="line">扇区大小(逻辑/物理)：<span class="number">512</span> 字节 / <span class="number">512</span> 字节</span><br><span class="line">I/O 大小(最小/最佳)：<span class="number">512</span> 字节 / <span class="number">512</span> 字节</span><br></pre></td></tr></table></figure>
        
          <p class="article-more-link">
            <a href="/2018/10/14/centos7%E6%8C%82%E8%BD%BD%E6%96%B0%E7%A1%AC%E7%9B%98/#more">Read More</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2018/10/14/centos7%E6%8C%82%E8%BD%BD%E6%96%B0%E7%A1%AC%E7%9B%98/" data-id="ckjr4vdyl0004f0ukck3t8if6" data-title="centos7挂载新硬盘" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux/" rel="tag">linux</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-vbox创建能和宿主机相互访问能访问公网的虚拟机" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2018/10/13/vbox%E5%88%9B%E5%BB%BA%E8%83%BD%E5%92%8C%E5%AE%BF%E4%B8%BB%E6%9C%BA%E7%9B%B8%E4%BA%92%E8%AE%BF%E9%97%AE%E8%83%BD%E8%AE%BF%E9%97%AE%E5%85%AC%E7%BD%91%E7%9A%84%E8%99%9A%E6%8B%9F%E6%9C%BA/" class="article-date">
  <time class="dt-published" datetime="2018-10-13T06:31:10.000Z" itemprop="datePublished">2018-10-13</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/linux/">linux</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2018/10/13/vbox%E5%88%9B%E5%BB%BA%E8%83%BD%E5%92%8C%E5%AE%BF%E4%B8%BB%E6%9C%BA%E7%9B%B8%E4%BA%92%E8%AE%BF%E9%97%AE%E8%83%BD%E8%AE%BF%E9%97%AE%E5%85%AC%E7%BD%91%E7%9A%84%E8%99%9A%E6%8B%9F%E6%9C%BA/">vbox创建能和宿主机相互访问能访问公网的虚拟机</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <ul>
<li><p>设置虚拟机名字<br><img src="http://file.ornobug.top/vbox/1.png"></p>
        
          <p class="article-more-link">
            <a href="/2018/10/13/vbox%E5%88%9B%E5%BB%BA%E8%83%BD%E5%92%8C%E5%AE%BF%E4%B8%BB%E6%9C%BA%E7%9B%B8%E4%BA%92%E8%AE%BF%E9%97%AE%E8%83%BD%E8%AE%BF%E9%97%AE%E5%85%AC%E7%BD%91%E7%9A%84%E8%99%9A%E6%8B%9F%E6%9C%BA/#more">Read More</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2018/10/13/vbox%E5%88%9B%E5%BB%BA%E8%83%BD%E5%92%8C%E5%AE%BF%E4%B8%BB%E6%9C%BA%E7%9B%B8%E4%BA%92%E8%AE%BF%E9%97%AE%E8%83%BD%E8%AE%BF%E9%97%AE%E5%85%AC%E7%BD%91%E7%9A%84%E8%99%9A%E6%8B%9F%E6%9C%BA/" data-id="ckjr4vdz70026f0uk3nf51ecw" data-title="vbox创建能和宿主机相互访问能访问公网的虚拟机" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux/" rel="tag">linux</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-zookeeper看山归来" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2018/09/23/zookeeper%E7%9C%8B%E5%B1%B1%E5%BD%92%E6%9D%A5/" class="article-date">
  <time class="dt-published" datetime="2018-09-23T02:55:04.000Z" itemprop="datePublished">2018-09-23</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/zookeeper/">zookeeper</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2018/09/23/zookeeper%E7%9C%8B%E5%B1%B1%E5%BD%92%E6%9D%A5/">zookeeper看山归来</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>zookeeper源码看了不少，得做些总结。</p>
<p>首先，zookeeper按照cap理论中的cp设计，在网络分区不可避免的情况下优先保证一致性。<br>如何保证一致性呢？<br>答案是通过事务投票。每当有事务请求发送到zookeeper服务器，如果是Follower接收到这个事务请求，该Follower就将请求转发到Leader，然后Leader会发起事务的投票，向所有Follower发送<code>Leader.PROPOSAL</code>的消息，然后收到该消息的Follower会返回一个<code>ACK</code>消息，Leader会在接收<code>ACK</code>消息这里等待，直到集群机器数量过半或者权重过半进行了响应。过半响应之后，Leader就会向Follower广播<code>Leader.COMMIT</code>消息，告诉Follower提交事务。对于Observer，就会发送完整的投票信息，让其提交。因为之前的事务投票，Observer并未参与，他不会持有具体的投票信息。经过事务投票，就能保证各点的数据一致。</p>
<p>这个过程可以看出，如果zookeeper集群很大，那过半响应的等待时间就会相应地变长，zookeeper的tps就会下降。这就很尴尬，明明是我们的小集群撑不住了，想增大集群增加性能，但是通过分析发现，写性能反而下降，蛋疼。</p>
<p>再看下为什么zookeeper不能保证<code>A</code>也就是可用性呢？<br>实际上zookeeper提供了选举来进行可用性的补充，但是假设我们的写数据请求数据量很大，导致一个Leader挂了，然后就会进行集群选举，选举也是一个要集群间各节点投票的过程，也会进行过半响应的等待，集群越大，等待时间越长，由于选举期间集群不能对外提供服务，导致集群不可用的时间也变长，而且就算选举好了，面对大量的写数据请求，还是会崩，又得选举，最后集群gg。</p>
<p>zookeeper 下所有节点不可能保证任何时候都能缓存所有的服务注册信息。如果zookeeper下所有的节点都断开了，或者集群中出现了网络分割的故障，那么zookeeper将会把他们从自己的管理范围内踢除，外界就不能访问到这些节点了，即使这些节点本身是健康的可以正常提供服务，所以导致到达这些节点的服务请求被丢失了。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2018/09/23/zookeeper%E7%9C%8B%E5%B1%B1%E5%BD%92%E6%9D%A5/" data-id="ckjr4vdzj0037f0uk6y4m6rts" data-title="zookeeper看山归来" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/zookeeper/" rel="tag">zookeeper</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-zookeeper配置文件" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2018/09/18/zookeeper%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/" class="article-date">
  <time class="dt-published" datetime="2018-09-18T12:55:04.000Z" itemprop="datePublished">2018-09-18</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/zookeeper/">zookeeper</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2018/09/18/zookeeper%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/">zookeeper配置文件</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p><a target="_blank" rel="noopener" href="http://zookeeper.apache.org/doc/r3.4.13/zookeeperAdmin.html#sc_configuration" title="3.4.13官网配置解析">3.4.13官网配置解析</a></p>
<h1 id="最简配置"><a href="#最简配置" class="headerlink" title="最简配置"></a>最简配置</h1><table>
<thead>
<tr>
<th align="center">配置项</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">clientPort</td>
<td align="left">服务端监听客户端连接的端口号，就是客户端尝试连接的端口</td>
</tr>
<tr>
<td align="center">dataDir</td>
<td align="left">快照文件存放的目录，如果没有指定<code>dataLogDir</code>，那么，事务日志也存放在该目录下</td>
</tr>
<tr>
<td align="center">tickTime</td>
<td align="left">单个心跳的时间长度，即ZooKeeper使用的基本时间单位，以毫秒为单位。它用于调节心跳和超时。例如，最小会话超时将是两个tickTime</td>
</tr>
</tbody></table>
        
          <p class="article-more-link">
            <a href="/2018/09/18/zookeeper%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/#more">Read More</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2018/09/18/zookeeper%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/" data-id="ckjr4vdzn003kf0uk0zu3361o" data-title="zookeeper配置文件" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/zookeeper/" rel="tag">zookeeper</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-zookeeper数据与存储" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2018/09/17/zookeeper%E6%95%B0%E6%8D%AE%E4%B8%8E%E5%AD%98%E5%82%A8/" class="article-date">
  <time class="dt-published" datetime="2018-09-17T13:53:20.000Z" itemprop="datePublished">2018-09-17</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/zookeeper/">zookeeper</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2018/09/17/zookeeper%E6%95%B0%E6%8D%AE%E4%B8%8E%E5%AD%98%E5%82%A8/">zookeeper数据与存储</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="事务日志"><a href="#事务日志" class="headerlink" title="事务日志"></a>事务日志</h1><h2 id="文件存储"><a href="#文件存储" class="headerlink" title="文件存储"></a>文件存储</h2><p>在zookeeper的配置文件<code>zoo.cfg</code>中会配置<code>dataDir</code>作为默认的事务日志存储目录，也可以指定<code>dataLogDir</code>作为事务日志存储目录。指定之后zookeeper会在这个目录下创建<code>version-2</code>子目录，这个目录指定事务日志格式的版本号，日志格式变，这个版本号也变。</p>
<p><img src="http://file.ornobug.top/zookeeper%E4%BA%8B%E5%8A%A1%E6%97%A5%E5%BF%97%E5%AD%98%E5%82%A8.png" alt="zookeeper事务日志存储" title="zookeeper事务日志存储"></p>
<p>这些日志文件有以下特点:</p>
<ul>
<li>大小一样，均为67108880kb，也就是64mb</li>
<li>文件后缀名有规律，都是16进制数字，事件延伸，数字变大<br>这些文件后会名实际是16进制的zxid，而且是写入当前日志文件的第一条事务记录的zxid。用zxid的原因是能快速找到某个事务id所在的日志文件。zxid高32位表示Leader周期，用16据进制表示的话，就是这里的<code>10000110f</code>中的第一位<code>1</code>;zxid的低32位表示操作序列号，换成16进制就是<code>10000110f</code>中的<code>0000110f</code>，16进制数的一位数占4个bit位。</li>
</ul>
<h2 id="日志格式"><a href="#日志格式" class="headerlink" title="日志格式"></a>日志格式</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * LogFile:</span></span><br><span class="line"><span class="comment"> *     文件头      事务    填充0</span></span><br><span class="line"><span class="comment"> *     FileHeader TxnList ZeroPad</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * FileHeader: &#123;</span></span><br><span class="line"><span class="comment"> *     magic 4bytes (ZKLG)</span></span><br><span class="line"><span class="comment"> *     version 4bytes</span></span><br><span class="line"><span class="comment"> *     dbid 8bytes</span></span><br><span class="line"><span class="comment"> *   &#125;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * TxnList:</span></span><br><span class="line"><span class="comment"> *     Txn || Txn TxnList</span></span><br><span class="line"><span class="comment"> *     </span></span><br><span class="line"><span class="comment"> * Txn:</span></span><br><span class="line"><span class="comment"> *     checksum Txnlen TxnHeader Record 0x42</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * checksum: 8bytes Adler32 is currently used</span></span><br><span class="line"><span class="comment"> *   calculated across payload -- Txnlen, TxnHeader, Record and 0x42</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Txnlen:</span></span><br><span class="line"><span class="comment"> *     len 4bytes</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * TxnHeader: &#123;</span></span><br><span class="line"><span class="comment"> *     sessionid 8bytes</span></span><br><span class="line"><span class="comment"> *     cxid 4bytes</span></span><br><span class="line"><span class="comment"> *     zxid 8bytes</span></span><br><span class="line"><span class="comment"> *     time 8bytes</span></span><br><span class="line"><span class="comment"> *     type 4bytes</span></span><br><span class="line"><span class="comment"> *   &#125;</span></span><br><span class="line"><span class="comment"> *     </span></span><br><span class="line"><span class="comment"> * Record:</span></span><br><span class="line"><span class="comment"> *     See Jute definition file for details on the various record types</span></span><br><span class="line"><span class="comment"> *      </span></span><br><span class="line"><span class="comment"> * ZeroPad:</span></span><br><span class="line"><span class="comment"> *     0 padded to EOF (filled during preallocation stage)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FileTxnLog</span> <span class="keyword">implements</span> <span class="title">TxnLog</span> </span>&#123;</span><br><span class="line">     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOG;</span><br><span class="line"></span><br><span class="line">     <span class="comment">// 预分配大小 64M</span></span><br><span class="line">     <span class="keyword">static</span> <span class="keyword">long</span> preAllocSize =  <span class="number">65536</span> * <span class="number">1024</span>;</span><br><span class="line"></span><br><span class="line">     <span class="comment">// 魔术数字，默认为1514884167</span></span><br><span class="line">     <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> TXNLOG_MAGIC =</span><br><span class="line">         ByteBuffer.wrap(<span class="string">&quot;ZKLG&quot;</span>.getBytes()).getInt();</span><br><span class="line"></span><br><span class="line">     <span class="comment">// 版本号</span></span><br><span class="line">     <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> VERSION = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">     <span class="comment">/** Maximum time we allow for elapsed fsync before WARNing */</span></span><br><span class="line">     <span class="comment">// 进行同步时，发出warn之前所能等待的最长时间</span></span><br><span class="line">     <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">long</span> fsyncWarningThresholdMS;</span><br><span class="line"></span><br><span class="line">     <span class="comment">// 静态属性，确定Logger、预分配空间大小和最长时间</span></span><br><span class="line">     <span class="keyword">static</span> &#123;</span><br><span class="line">         LOG = LoggerFactory.getLogger(FileTxnLog.class);</span><br><span class="line"></span><br><span class="line">         String size = System.getProperty(<span class="string">&quot;zookeeper.preAllocSize&quot;</span>);</span><br><span class="line">         <span class="keyword">if</span> (size != <span class="keyword">null</span>) &#123;</span><br><span class="line">             <span class="keyword">try</span> &#123;</span><br><span class="line">                 preAllocSize = Long.parseLong(size) * <span class="number">1024</span>;</span><br><span class="line">             &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</span><br><span class="line">                 LOG.warn(size + <span class="string">&quot; is not a valid value for preAllocSize&quot;</span>);</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">         fsyncWarningThresholdMS = Long.getLong(<span class="string">&quot;fsync.warningthresholdms&quot;</span>, <span class="number">1000</span>);</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="comment">// 最大(新)的zxid</span></span><br><span class="line">     <span class="keyword">long</span> lastZxidSeen;</span><br><span class="line">     <span class="comment">// 存储数据相关的流</span></span><br><span class="line">     <span class="keyword">volatile</span> BufferedOutputStream logStream = <span class="keyword">null</span>;</span><br><span class="line">     <span class="keyword">volatile</span> OutputArchive oa;</span><br><span class="line">     <span class="keyword">volatile</span> FileOutputStream fos = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">     <span class="comment">// log目录文件</span></span><br><span class="line">     File logDir;</span><br><span class="line"></span><br><span class="line">     <span class="comment">// 是否强制同步</span></span><br><span class="line">     <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> forceSync = !System.getProperty(<span class="string">&quot;zookeeper.forceSync&quot;</span>, <span class="string">&quot;yes&quot;</span>).equals(<span class="string">&quot;no&quot;</span>);;</span><br><span class="line"></span><br><span class="line">     <span class="comment">// 数据库id</span></span><br><span class="line">     <span class="keyword">long</span> dbId;</span><br><span class="line"></span><br><span class="line">     <span class="comment">// 流列表</span></span><br><span class="line">     <span class="keyword">private</span> LinkedList&lt;FileOutputStream&gt; streamsToFlush =</span><br><span class="line">         <span class="keyword">new</span> LinkedList&lt;FileOutputStream&gt;();</span><br><span class="line"></span><br><span class="line">     <span class="comment">// 当前大小</span></span><br><span class="line">     <span class="keyword">long</span> currentSize;</span><br><span class="line">     <span class="comment">// 写日志文件</span></span><br><span class="line">     File logFileWrite = <span class="keyword">null</span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>在zookeeper的home目录执行</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">java -classpath .:lib/slf4j-api-<span class="number">1.7</span><span class="number">.25</span>.jar:zookeeper-<span class="number">3.4</span><span class="number">.13</span>.jar org.apache.zookeeper.server.LogFormatter logs/version-<span class="number">2</span>/log<span class="number">.1</span></span><br><span class="line"></span><br><span class="line">ZooKeeper Transactional Log File with dbid <span class="number">0</span> txnlog format version <span class="number">2</span></span><br><span class="line"><span class="number">9</span>/<span class="number">17</span>/<span class="number">18</span> <span class="number">10</span>:<span class="number">10</span>:<span class="number">40</span> PM CST session <span class="number">0x10107a2dbc60000</span> cxid <span class="number">0x12</span> zxid <span class="number">0x300000003</span> closeSession <span class="keyword">null</span></span><br><span class="line">EOF reached after <span class="number">1</span> txns.</span><br></pre></td></tr></table></figure>

<h2 id="日志写入"><a href="#日志写入" class="headerlink" title="日志写入"></a>日志写入</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FileTxnLog#append()</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">boolean</span> <span class="title">append</span><span class="params">(TxnHeader hdr, Record txn)</span> <span class="keyword">throws</span> IOException  </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (hdr != <span class="keyword">null</span>) &#123; <span class="comment">// 事务头部不为空</span></span><br><span class="line">        <span class="keyword">if</span> (hdr.getZxid() &lt;= lastZxidSeen) &#123; <span class="comment">// 事务的zxid小于等于最后的zxid</span></span><br><span class="line">            LOG.warn(<span class="string">&quot;Current zxid &quot;</span> + hdr.getZxid()</span><br><span class="line">                    + <span class="string">&quot; is &lt;= &quot;</span> + lastZxidSeen + <span class="string">&quot; for &quot;</span></span><br><span class="line">                    + hdr.getType());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (logStream==<span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 日志流为空，没有事务日志与其关联</span></span><br><span class="line">           <span class="keyword">if</span>(LOG.isInfoEnabled())&#123;</span><br><span class="line">                LOG.info(<span class="string">&quot;Creating new log file: log.&quot;</span> +  </span><br><span class="line">                        Long.toHexString(hdr.getZxid()));</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="comment">// log.16进制的zxid作为事务日志文件名</span></span><br><span class="line">           logFileWrite = <span class="keyword">new</span> File(logDir, (<span class="string">&quot;log.&quot;</span> +</span><br><span class="line">                   Long.toHexString(hdr.getZxid())));</span><br><span class="line">           fos = <span class="keyword">new</span> FileOutputStream(logFileWrite);</span><br><span class="line">           logStream=<span class="keyword">new</span> BufferedOutputStream(fos);</span><br><span class="line">           oa = BinaryOutputArchive.getArchive(logStream);</span><br><span class="line">           <span class="comment">// 否早事务日志文件头信息，包含魔数，格式化版本号，内存数据库id</span></span><br><span class="line">           FileHeader fhdr = <span class="keyword">new</span> FileHeader(TXNLOG_MAGIC,VERSION, dbId);</span><br><span class="line">           <span class="comment">// 序列化事务日志头</span></span><br><span class="line">           fhdr.serialize(oa, <span class="string">&quot;fileheader&quot;</span>);</span><br><span class="line">           <span class="comment">// Make sure that the magic number is written before padding.</span></span><br><span class="line">           <span class="comment">// 将文件头信息刷新到磁盘</span></span><br><span class="line">           logStream.flush();</span><br><span class="line"></span><br><span class="line">           <span class="comment">// 当前通道的大小</span></span><br><span class="line">           filePadding.setCurrentSize(fos.getChannel().position());</span><br><span class="line">           <span class="comment">// 添加fos</span></span><br><span class="line">           streamsToFlush.add(fos);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 0填充文件</span></span><br><span class="line">        filePadding.padFile(fos.getChannel());</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * pad the current file to increase its size to the next multiple of preAllocSize greater than the current size and position</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> fileChannel the fileChannel of the file to be padded</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="comment">// FilePadding#padFile()</span></span><br><span class="line"><span class="function"><span class="keyword">long</span> <span class="title">padFile</span><span class="params">(FileChannel fileChannel)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">// 磁盘空间预分配</span></span><br><span class="line">    <span class="keyword">long</span> newFileSize = calculateFileSizeWithPadding(fileChannel.position(), currentSize, preAllocSize);</span><br><span class="line">    <span class="keyword">if</span> (currentSize != newFileSize) &#123;</span><br><span class="line">        <span class="comment">// 新文件填充0</span></span><br><span class="line">        fileChannel.write((ByteBuffer) fill.position(<span class="number">0</span>), newFileSize - fill.remaining());</span><br><span class="line">        currentSize = newFileSize;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> currentSize;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Calculates a new file size with padding. We only return a new size if</span></span><br><span class="line"><span class="comment"> * the current file position is sufficiently close (less than 4K) to end of</span></span><br><span class="line"><span class="comment"> * file and preAllocSize is &gt; 0.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> position     the point in the file we have written to</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> fileSize     application keeps track of the current file size</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> preAllocSize how many bytes to pad</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> the new file size. It can be the same as fileSize if no</span></span><br><span class="line"><span class="comment"> * padding was done.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// VisibleForTesting</span></span><br><span class="line"><span class="comment">// FilePadding#calculateFileSizeWithPadding()</span></span><br><span class="line"><span class="comment">// 磁盘空间预分配</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">long</span> <span class="title">calculateFileSizeWithPadding</span><span class="params">(<span class="keyword">long</span> position, <span class="keyword">long</span> fileSize, <span class="keyword">long</span> preAllocSize)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// If preAllocSize is positive and we are within 4KB of the known end of the file calculate a new file size</span></span><br><span class="line">    <span class="keyword">if</span> (preAllocSize &gt; <span class="number">0</span> &amp;&amp; position + <span class="number">4096</span> &gt;= fileSize) &#123;</span><br><span class="line">        <span class="comment">// If we have written more than we have previously preallocated we need to make sure the new</span></span><br><span class="line">        <span class="comment">// file size is larger than what we already have</span></span><br><span class="line">        <span class="comment">// 如果preAllocSize大于0并且事务日志剩余空间不足4096byte就会进行文件扩容</span></span><br><span class="line">        <span class="keyword">if</span> (position &gt; fileSize) &#123;</span><br><span class="line">            <span class="comment">// 如果写入位置超过文件大小</span></span><br><span class="line">            <span class="comment">// 先加上64mb的大小</span></span><br><span class="line">            fileSize = position + preAllocSize;</span><br><span class="line">            <span class="comment">// 然后削减调超出的部分，使fileSize为64mb的倍数</span></span><br><span class="line">            fileSize -= fileSize % preAllocSize;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 写入位置小于文件大小，则fileSize直接加上preAllocSize(64mb)的大小</span></span><br><span class="line">            fileSize += preAllocSize;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> fileSize;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Serializes transaction header and transaction data into a byte buffer.</span></span><br><span class="line">        <span class="comment">// 将事务头和事务数据序列化成Byte Buffer</span></span><br><span class="line">        <span class="keyword">byte</span>[] buf = Util.marshallTxnEntry(hdr, txn);</span><br><span class="line">        <span class="keyword">if</span> (buf == <span class="keyword">null</span> || buf.length == <span class="number">0</span>) &#123; <span class="comment">// 为空，抛出异常</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;Faulty serialization for header &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;and txn&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 生成一个验证算法</span></span><br><span class="line">        Checksum crc = makeChecksumAlgorithm();</span><br><span class="line">        <span class="comment">// Updates the current checksum with the specified array of bytes</span></span><br><span class="line">        <span class="comment">// 使用Byte数组来更新当前的Checksum</span></span><br><span class="line">        crc.update(buf, <span class="number">0</span>, buf.length);</span><br><span class="line">        <span class="comment">// 写long类型数据</span></span><br><span class="line">        oa.writeLong(crc.getValue(), <span class="string">&quot;txnEntryCRC&quot;</span>);</span><br><span class="line">        <span class="comment">// Write the serialized transaction record to the output archive.</span></span><br><span class="line">        <span class="comment">// 将序列化的事务记录写入OutputArchive</span></span><br><span class="line">        Util.writeTxnBytes(oa, buf);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>append函数主要步骤如下:</p>
<ol>
<li>检查TxnHeader是否为空，若不为空，则进入2，否则，直接返回false。zookeeper在启动完成后需要进行第一次日志的写入，或者上个事务日志写满，都会处于和事务日志断开的状态，因此，此处需要判断<code>FileTxnLog</code>是否与可写的事务日志关联。</li>
<li>检查logStream是否为空(初始化为空)，若不为空，则进入3，否则，进入5</li>
<li>初始化写数据相关的流和FileHeader，并序列化FileHeader至指定文件，进入4</li>
<li>强制刷新（保证数据存到磁盘），并获取当前写入数据的大小。进入5</li>
<li>填充数据，填充0，进入6。填充0的过程中进行了磁盘空间预分配，为什么这么做？答案就是拿空间换时间。每当有事务请求过来，zookeeper都要写入到事务日志，不使用预分配策略的话，就会经常随机寻址，数据也散落地乱七八糟。使用预分配之后，会让文件占用连续的磁盘空间，减少寻址开销；迅速占用磁盘空间。防止使用过程中空间不足。</li>
<li>将事务头和事务序列化成ByteBuffer（使用Util.marshallTxnEntry函数），进入7</li>
<li>为保证事务日志的完整性和数据准确性，使用Checksum算法(默认<code>Adler32</code>算法)更新步骤6的ByteBuffer。进入8</li>
<li>将更新的ByteBuffer写入磁盘文件，返回true</li>
</ol>
<h2 id="日志截断"><a href="#日志截断" class="headerlink" title="日志截断"></a>日志截断</h2><p>在集群运行中，可能出现这样的情况:非Leader机器的zxid(peerLastZxid)大于Leader的zxid，这是非法的，因为集群只能有一个Leader，所以当前Leader就发送<code>TRUNC</code>消息给这个机器，要求该机器进行日志截断。Learner服务器接收到该消息后，会删除包含或大于peerLastZxid的事务日志文件。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * truncate the current transaction logs</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> zxid the zxid to truncate the logs to</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> true if successful false if not</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="comment">// FileTxnLog#truncate()</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">truncate</span><span class="params">(<span class="keyword">long</span> zxid)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    FileTxnIterator itr = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 要删除的事务日志文件</span></span><br><span class="line">        itr = <span class="keyword">new</span> FileTxnIterator(<span class="keyword">this</span>.logDir, zxid);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FileTxnLog$FileTxnIterator</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">FileTxnIterator</span><span class="params">(File logDir, <span class="keyword">long</span> zxid)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.logDir = logDir;</span><br><span class="line">    <span class="keyword">this</span>.zxid = zxid;</span><br><span class="line">    init();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// FileTxnLog$FileTxnIterator#init()</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    storedFiles = <span class="keyword">new</span> ArrayList&lt;File&gt;();</span><br><span class="line">    List&lt;File&gt; files = Util.sortDataDir(FileTxnLog.getLogFiles(logDir.listFiles(), <span class="number">0</span>), LOG_FILE_PREFIX, <span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">for</span> (File f: files) &#123;</span><br><span class="line">        <span class="comment">// 筛选要截断删除的事务日志</span></span><br><span class="line">        <span class="keyword">if</span> (Util.getZxidFromName(f.getName(), LOG_FILE_PREFIX) &gt;= zxid) &#123;</span><br><span class="line">            storedFiles.add(f);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// add the last logfile that is less than the zxid</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (Util.getZxidFromName(f.getName(), LOG_FILE_PREFIX) &lt; zxid) &#123;</span><br><span class="line">            storedFiles.add(f);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    goToNextLog();</span><br><span class="line">    <span class="keyword">if</span> (!next())</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">while</span> (hdr.getZxid() &lt; zxid) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!next())</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">        PositionInputStream input = itr.inputStream;</span><br><span class="line">        <span class="keyword">if</span>(input == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;No log files found to truncate! This could &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;happen if you still have snapshots from an old setup or &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;log files were deleted accidentally or dataLogDir was changed in zoo.cfg.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">long</span> pos = input.getPosition();</span><br><span class="line">        <span class="comment">// now, truncate at the current position</span></span><br><span class="line">        RandomAccessFile raf = <span class="keyword">new</span> RandomAccessFile(itr.logFile, <span class="string">&quot;rw&quot;</span>);</span><br><span class="line">        raf.setLength(pos);</span><br><span class="line">        raf.close();</span><br><span class="line">        <span class="keyword">while</span> (itr.goToNextLog()) &#123;</span><br><span class="line">            <span class="comment">// 删除日志</span></span><br><span class="line">            <span class="keyword">if</span> (!itr.logFile.delete()) &#123;</span><br><span class="line">                LOG.warn(<span class="string">&quot;Unable to truncate &#123;&#125;&quot;</span>, itr.logFile);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        close(itr);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="数据快照"><a href="#数据快照" class="headerlink" title="数据快照"></a>数据快照</h1><h2 id="文件存储-1"><a href="#文件存储-1" class="headerlink" title="文件存储"></a>文件存储</h2><p>这里的快照文件存放在<code>$dataDir/version-2/</code>下，文件名和上边的事务日志文件类似，例如:<code>snapshot.2c021384ce</code>，命名规则和事务日志文件一致。唯一的不同就是快照文件没有磁盘空间预分配，文件尾部不会填充大量0。</p>
<h2 id="快照格式"><a href="#快照格式" class="headerlink" title="快照格式"></a>快照格式</h2><p>格式化快照文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在zookeeper的home目录下</span></span><br><span class="line">java -classpath .:lib/slf4j-api-<span class="number">1.6</span><span class="number">.1</span>.jar:zookeeper-<span class="number">3.4</span><span class="number">.9</span>.jar org.apache.zookeeper.server.SnapshotFormatter data/version-<span class="number">2</span>/snapshot<span class="number">.300000001</span></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">ZNode <span class="title">Details</span> <span class="params">(count=<span class="number">20</span>)</span>:</span></span><br><span class="line"><span class="function">----</span></span><br><span class="line"><span class="function">/</span></span><br><span class="line"><span class="function">  cZxid </span>= <span class="number">0x00000000000000</span></span><br><span class="line">  ctime = Thu Jan <span class="number">01</span> 08:<span class="number">00</span>:<span class="number">00</span> CST <span class="number">1970</span></span><br><span class="line">  mZxid = <span class="number">0x00000000000000</span></span><br><span class="line">  mtime = Thu Jan <span class="number">01</span> 08:<span class="number">00</span>:<span class="number">00</span> CST <span class="number">1970</span></span><br><span class="line">  pZxid = <span class="number">0x00000200000009</span></span><br><span class="line">  cversion = <span class="number">90</span></span><br><span class="line">  dataVersion = <span class="number">0</span></span><br><span class="line">  aclVersion = <span class="number">0</span></span><br><span class="line">  ephemeralOwner = <span class="number">0x00000000000000</span></span><br><span class="line">  dataLength = <span class="number">0</span></span><br><span class="line">----</span><br><span class="line">/curator_master_select</span><br><span class="line">  cZxid = <span class="number">0x00000100000723</span></span><br><span class="line">  ctime = Sun Aug <span class="number">19</span> <span class="number">22</span>:<span class="number">12</span>:<span class="number">49</span> CST <span class="number">2018</span></span><br><span class="line">  mZxid = <span class="number">0x00000100000723</span></span><br><span class="line">  mtime = Sun Aug <span class="number">19</span> <span class="number">22</span>:<span class="number">12</span>:<span class="number">49</span> CST <span class="number">2018</span></span><br><span class="line">  pZxid = <span class="number">0x00000100000737</span></span><br><span class="line">  cversion = <span class="number">1</span></span><br><span class="line">  dataVersion = <span class="number">0</span></span><br><span class="line">  aclVersion = <span class="number">0</span></span><br><span class="line">  ephemeralOwner = <span class="number">0x00000000000000</span></span><br><span class="line">  dataLength = <span class="number">0</span></span><br><span class="line">----</span><br><span class="line">...</span><br><span class="line">----</span><br><span class="line">/curator_zkpaths/c1</span><br><span class="line">  cZxid = <span class="number">0x000001000010fa</span></span><br><span class="line">  ctime = Tue Aug <span class="number">21</span> <span class="number">22</span>:<span class="number">27</span>:<span class="number">18</span> CST <span class="number">2018</span></span><br><span class="line">  mZxid = <span class="number">0x000001000010fa</span></span><br><span class="line">  mtime = Tue Aug <span class="number">21</span> <span class="number">22</span>:<span class="number">27</span>:<span class="number">18</span> CST <span class="number">2018</span></span><br><span class="line">  pZxid = <span class="number">0x000001000010fa</span></span><br><span class="line">  cversion = <span class="number">0</span></span><br><span class="line">  dataVersion = <span class="number">0</span></span><br><span class="line">  aclVersion = <span class="number">0</span></span><br><span class="line">  ephemeralOwner = <span class="number">0x00000000000000</span></span><br><span class="line">  dataLength = <span class="number">0</span></span><br><span class="line">----</span><br><span class="line"><span class="function">Session <span class="title">Details</span> <span class="params">(sid, timeout, ephemeralCount)</span>:</span></span><br><span class="line"><span class="function">0x10107a2dbc60000, 5000, 0</span></span><br></pre></td></tr></table></figure>
<h2 id="快照写入"><a href="#快照写入" class="headerlink" title="快照写入"></a>快照写入</h2><p>在若干次事务之后，zookeeper会将内存数据库的全量数据dump到本地文件，这就是数据快照，可以使用<code>snapCount</code>来设置进过多少次事务进行快照操作。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SyncRequestProcessor#run()</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">int</span> logCount = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// we do this in an attempt to ensure that not all of the servers</span></span><br><span class="line">        <span class="comment">// in the ensemble take a snapshot at the same time</span></span><br><span class="line"></span><br><span class="line">        setRandRoll(r.nextInt(snapCount/<span class="number">2</span>));</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            Request si = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (toFlush.isEmpty()) &#123;</span><br><span class="line">                si = queuedRequests.take();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                si = queuedRequests.poll();</span><br><span class="line">                <span class="keyword">if</span> (si == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    flush(toFlush);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (si == requestOfDeath) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (si != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// track the number of records written to the log</span></span><br><span class="line">                <span class="keyword">if</span> (zks.getZKDatabase().append(si)) &#123;</span><br><span class="line">                    logCount++;</span><br><span class="line">                    <span class="comment">// 确保并非整体中的所有服务器同时拍摄快照，因为这样会影响集群整体性能</span></span><br><span class="line">                    <span class="keyword">if</span> (logCount &gt; (snapCount / <span class="number">2</span> + randRoll)) &#123;</span><br><span class="line">                        setRandRoll(r.nextInt(snapCount/<span class="number">2</span>));</span><br><span class="line">                        <span class="comment">// roll the log</span></span><br><span class="line">                        <span class="comment">// 切换事务日志文件</span></span><br><span class="line">                        zks.getZKDatabase().rollLog();</span><br><span class="line">                        <span class="comment">// take a snapshot</span></span><br><span class="line">                        <span class="keyword">if</span> (snapInProcess != <span class="keyword">null</span> &amp;&amp; snapInProcess.isAlive()) &#123;</span><br><span class="line">                            LOG.warn(<span class="string">&quot;Too busy to snap, skipping&quot;</span>);</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="comment">// 创建快照线程，异步执行</span></span><br><span class="line">                            snapInProcess = <span class="keyword">new</span> ZooKeeperThread(<span class="string">&quot;Snapshot Thread&quot;</span>) &#123;</span><br><span class="line">                                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                                        <span class="keyword">try</span> &#123;</span><br><span class="line">                                            <span class="comment">// 快照数据</span></span><br><span class="line">                                            zks.takeSnapshot();</span><br><span class="line">                                        &#125; <span class="keyword">catch</span>(Exception e) &#123;</span><br><span class="line">                                            LOG.warn(<span class="string">&quot;Unexpected exception&quot;</span>, e);</span><br><span class="line">                                        &#125;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;;</span><br><span class="line">                            snapInProcess.start();</span><br><span class="line">                        &#125;</span><br><span class="line">                        logCount = <span class="number">0</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (toFlush.isEmpty()) &#123;</span><br><span class="line">                    <span class="comment">// optimization for read heavy workloads</span></span><br><span class="line">                    <span class="comment">// iff this is a read, and there are no pending</span></span><br><span class="line">                    <span class="comment">// flushes (writes), then just pass this to the next</span></span><br><span class="line">                    <span class="comment">// processor</span></span><br><span class="line">                    <span class="keyword">if</span> (nextProcessor != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        nextProcessor.processRequest(si);</span><br><span class="line">                        <span class="keyword">if</span> (nextProcessor <span class="keyword">instanceof</span> Flushable) &#123;</span><br><span class="line">                            ((Flushable)nextProcessor).flush();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                toFlush.add(si);</span><br><span class="line">                <span class="keyword">if</span> (toFlush.size() &gt; <span class="number">1000</span>) &#123;</span><br><span class="line">                    flush(toFlush);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        handleException(<span class="keyword">this</span>.getName(), t);</span><br><span class="line">        running = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    LOG.info(<span class="string">&quot;SyncRequestProcessor exited!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// FileTxnLog#rollLog()</span></span><br><span class="line"><span class="comment">// 将当前日志文件翻转为新文件</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">rollLog</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (logStream != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 日志数据刷新到文件</span></span><br><span class="line">        <span class="keyword">this</span>.logStream.flush();</span><br><span class="line">        <span class="comment">// 断开zookeeper与事务日志的关联</span></span><br><span class="line">        <span class="keyword">this</span>.logStream = <span class="keyword">null</span>;</span><br><span class="line">        oa = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ZooKeeperServer#takeSnapshot()</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">takeSnapshot</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        txnLogFactory.save(zkDb.getDataTree(), zkDb.getSessionWithTimeOuts());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        LOG.error(<span class="string">&quot;Severe unrecoverable error, exiting&quot;</span>, e);</span><br><span class="line">        <span class="comment">// This is a severe error that we cannot recover from,</span></span><br><span class="line">        <span class="comment">// so we need to exit</span></span><br><span class="line">        System.exit(<span class="number">10</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// FileTxnSnapLog#save()</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">save</span><span class="params">(DataTree dataTree,</span></span></span><br><span class="line"><span class="function"><span class="params">        ConcurrentHashMap&lt;Long, Integer&gt; sessionsWithTimeouts)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> lastZxid = dataTree.lastProcessedZxid;</span><br><span class="line">    <span class="comment">// 指定文件</span></span><br><span class="line">    File snapshotFile = <span class="keyword">new</span> File(snapDir, Util.makeSnapshotName(lastZxid));</span><br><span class="line">    LOG.info(<span class="string">&quot;Snapshotting: 0x&#123;&#125; to &#123;&#125;&quot;</span>, Long.toHexString(lastZxid),</span><br><span class="line">            snapshotFile);</span><br><span class="line">    <span class="comment">// 实际的序列化和刷新到硬盘</span></span><br><span class="line">    snapLog.serialize(dataTree, sessionsWithTimeouts, snapshotFile);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// FileSnap#serialize()</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">serialize</span><span class="params">(DataTree dt, Map&lt;Long, Integer&gt; sessions, File snapShot)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!close) &#123;</span><br><span class="line">        OutputStream sessOS = <span class="keyword">new</span> BufferedOutputStream(<span class="keyword">new</span> FileOutputStream(snapShot));</span><br><span class="line">        CheckedOutputStream crcOut = <span class="keyword">new</span> CheckedOutputStream(sessOS, <span class="keyword">new</span> Adler32());</span><br><span class="line">        <span class="comment">//CheckedOutputStream cout = new CheckedOutputStream()</span></span><br><span class="line">        OutputArchive oa = BinaryOutputArchive.getArchive(crcOut);</span><br><span class="line">        <span class="comment">// 构造快照文件头</span></span><br><span class="line">        FileHeader header = <span class="keyword">new</span> FileHeader(SNAP_MAGIC, VERSION, dbId);</span><br><span class="line">        <span class="comment">// 将整棵DataTree树和会话信息以及文件头写入到OutputArchive</span></span><br><span class="line">        serialize(dt,sessions,oa, header);</span><br><span class="line">        <span class="comment">// 生成校验码，写入OutputArchive</span></span><br><span class="line">        <span class="keyword">long</span> val = crcOut.getChecksum().getValue();</span><br><span class="line">        oa.writeLong(val, <span class="string">&quot;val&quot;</span>);</span><br><span class="line">        oa.writeString(<span class="string">&quot;/&quot;</span>, <span class="string">&quot;path&quot;</span>);</span><br><span class="line">        sessOS.flush();</span><br><span class="line">        crcOut.close();</span><br><span class="line">        sessOS.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>数据快照的大体步骤如下:</p>
<ol>
<li>判断是否需要快照。使用<code>logCount &gt; (snapCount / 2 + randRoll)</code>来进行判断，<code>randRoll=r.nextInt(snapCount/2)</code>，这是一种过半随机策略。<code>logCount</code>代表已经记录的事务日志数量，randRoll为<code>1~snapCount/2</code>的随机数。假如<code>snapCount</code>配置为10000，那么zookeeper就会在5000~10000次事务日志记录后进行数据快照。</li>
<li>切换事务日志文件。进行了snapCount个事务日志的记录，认为当前事务日志”写满”(并不是说到了64mb，而是说写够了该换新的了，不管你事务日志文件写了多少)了，所以要新建一个事务日志。</li>
<li>创建快照线程，异步执行，不影响主流程</li>
<li>将整棵DataTree树和会话信息以及文件头写入到OutputArchive</li>
</ol>
<h1 id="数据初始化"><a href="#数据初始化" class="headerlink" title="数据初始化"></a>数据初始化</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// QuorumPeer</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">QuorumPeer</span><span class="params">(Map&lt;Long, QuorumServer&gt; quorumPeers, File dataDir,</span></span></span><br><span class="line"><span class="function"><span class="params">        File dataLogDir, <span class="keyword">int</span> electionType,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">long</span> myid, <span class="keyword">int</span> tickTime, <span class="keyword">int</span> initLimit, <span class="keyword">int</span> syncLimit,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> quorumListenOnAllIPs,</span></span></span><br><span class="line"><span class="function"><span class="params">        ServerCnxnFactory cnxnFactory,</span></span></span><br><span class="line"><span class="function"><span class="params">        QuorumVerifier quorumConfig)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 各个服务器启动后会初始化FileTxnSnapLog</span></span><br><span class="line">    <span class="comment">// 并把数据加载到内存数据库</span></span><br><span class="line">    <span class="keyword">this</span>.logFactory = <span class="keyword">new</span> FileTxnSnapLog(dataLogDir, dataDir);</span><br><span class="line">    <span class="keyword">this</span>.zkDb = <span class="keyword">new</span> ZKDatabase(<span class="keyword">this</span>.logFactory);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// FileTxnSnapLog</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">FileTxnSnapLog</span><span class="params">(File dataDir, File snapDir)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        LOG.debug(<span class="string">&quot;Opening datadir:&#123;&#125; snapDir:&#123;&#125;&quot;</span>, dataDir, snapDir);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 事务日志目录</span></span><br><span class="line">    <span class="keyword">this</span>.dataDir = <span class="keyword">new</span> File(dataDir, version + VERSION);</span><br><span class="line">    <span class="comment">// 快照文件目录</span></span><br><span class="line">    <span class="keyword">this</span>.snapDir = <span class="keyword">new</span> File(snapDir, version + VERSION);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.dataDir.exists()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>.dataDir.mkdirs()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;Unable to create data directory &quot;</span></span><br><span class="line">                    + <span class="keyword">this</span>.dataDir);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.dataDir.canWrite()) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;Cannot write to data directory &quot;</span> + <span class="keyword">this</span>.dataDir);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.snapDir.exists()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>.snapDir.mkdirs()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;Unable to create snap directory &quot;</span></span><br><span class="line">                    + <span class="keyword">this</span>.snapDir);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.snapDir.canWrite()) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;Cannot write to snap directory &quot;</span> + <span class="keyword">this</span>.snapDir);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// check content of transaction log and snapshot dirs if they are two different directories</span></span><br><span class="line">    <span class="comment">// See ZOOKEEPER-2967 for more details</span></span><br><span class="line">    <span class="comment">// 如果它们是两个不同的目录，则检查事务日志和快照目录的内容</span></span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">this</span>.dataDir.getPath().equals(<span class="keyword">this</span>.snapDir.getPath()))&#123;</span><br><span class="line">        <span class="comment">// 检查是否以 log. 开头</span></span><br><span class="line">        checkLogDir();</span><br><span class="line">        <span class="comment">// 检查是否以 snapshot. 开头</span></span><br><span class="line">        checkSnapDir();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 分别初始化事务日志和数据快照</span></span><br><span class="line">    txnLog = <span class="keyword">new</span> FileTxnLog(<span class="keyword">this</span>.dataDir);</span><br><span class="line">    snapLog = <span class="keyword">new</span> FileSnap(<span class="keyword">this</span>.snapDir);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ZKDatabase</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ZKDatabase</span><span class="params">(FileTxnSnapLog snapLog)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 初始化树</span></span><br><span class="line">    dataTree = <span class="keyword">new</span> DataTree();</span><br><span class="line">    <span class="comment">// 初始化会话超时时间记录器，保存所有客户端会话的超时时间</span></span><br><span class="line">    sessionsWithTimeouts = <span class="keyword">new</span> ConcurrentHashMap&lt;Long, Integer&gt;();</span><br><span class="line">    <span class="keyword">this</span>.snapLog = snapLog;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// DataTree</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">DataTree</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">/* Rather than fight it, let root have an alias */</span></span><br><span class="line">    nodes.put(<span class="string">&quot;&quot;</span>, root);</span><br><span class="line">    <span class="comment">// 初始化 root节点 &quot;/&quot;</span></span><br><span class="line">    nodes.put(rootZookeeper, root);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** add the proc node and quota node */</span></span><br><span class="line">    <span class="comment">// 初始化 &quot;/zookeeper&quot;节点</span></span><br><span class="line">    root.addChild(procChildZookeeper);</span><br><span class="line">    nodes.put(procZookeeper, procDataNode);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化 &quot;/zookeeper/quota&quot; 节点</span></span><br><span class="line">    procDataNode.addChild(quotaChildZookeeper);</span><br><span class="line">    nodes.put(quotaZookeeper, quotaDataNode);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>QuorumPeer执行start方法后</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// QuorumPeer#start()</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    loadDataBase();</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// QuorumPeer#loadDataBase()</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loadDataBase</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    zkDb.loadDataBase();</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ZKDatabase#loadDataBase()</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">loadDataBase</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">// dataTree和sessionsWithTimeouts是上边初始化的，里边基本没内容</span></span><br><span class="line">    <span class="keyword">long</span> zxid = snapLog.restore(dataTree, sessionsWithTimeouts, commitProposalPlaybackListener);</span><br><span class="line">    initialized = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">return</span> zxid;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// FileTxnSnapLog#restore()</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">restore</span><span class="params">(DataTree dt, Map&lt;Long, Integer&gt; sessions,</span></span></span><br><span class="line"><span class="function"><span class="params">        PlayBackListener listener)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">// 解析快照文件</span></span><br><span class="line">    snapLog.deserialize(dt, sessions);</span><br><span class="line">    <span class="comment">// 处理事务日志</span></span><br><span class="line">    <span class="keyword">return</span> fastForwardFromEdits(dt, sessions, listener);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="处理快照数据"><a href="#处理快照数据" class="headerlink" title="处理快照数据"></a>处理快照数据</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FileSnap#deserialize()</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">deserialize</span><span class="params">(DataTree dt, Map&lt;Long, Integer&gt; sessions)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">// we run through 100 snapshots (not all of them)</span></span><br><span class="line">    <span class="comment">// if we cannot get it running within 100 snapshots</span></span><br><span class="line">    <span class="comment">// we should  give up</span></span><br><span class="line">    <span class="comment">// 获取最新的100个快照文件</span></span><br><span class="line">    List&lt;File&gt; snapList = findNValidSnapshots(<span class="number">100</span>);</span><br><span class="line">    <span class="keyword">if</span> (snapList.size() == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1L</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    File snap = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">boolean</span> foundValid = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; snapList.size(); i++) &#123;</span><br><span class="line">        snap = snapList.get(i);</span><br><span class="line">        InputStream snapIS = <span class="keyword">null</span>;</span><br><span class="line">        CheckedInputStream crcIn = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            LOG.info(<span class="string">&quot;Reading snapshot &quot;</span> + snap);</span><br><span class="line">            snapIS = <span class="keyword">new</span> BufferedInputStream(<span class="keyword">new</span> FileInputStream(snap));</span><br><span class="line">            crcIn = <span class="keyword">new</span> CheckedInputStream(snapIS, <span class="keyword">new</span> Adler32());</span><br><span class="line">            InputArchive ia = BinaryInputArchive.getArchive(crcIn);</span><br><span class="line">            <span class="comment">// 将快照数据发序列化到datatree和sessions集合中</span></span><br><span class="line">            deserialize(dt,sessions, ia);</span><br><span class="line">            <span class="comment">// 数据校验是否一致</span></span><br><span class="line">            <span class="keyword">long</span> checkSum = crcIn.getChecksum().getValue();</span><br><span class="line">            <span class="keyword">long</span> val = ia.readLong(<span class="string">&quot;val&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (val != checkSum) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;CRC corruption in snapshot :  &quot;</span> + snap);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 校验合格跳出循环，如果第一个（最新的一个）就校验通过了，那么剩余的99个也不校验了</span></span><br><span class="line">            foundValid = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span>(IOException e) &#123;</span><br><span class="line">            LOG.warn(<span class="string">&quot;problem reading snap file &quot;</span> + snap, e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (snapIS != <span class="keyword">null</span>)</span><br><span class="line">                snapIS.close();</span><br><span class="line">            <span class="keyword">if</span> (crcIn != <span class="keyword">null</span>)</span><br><span class="line">                crcIn.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果100个都没能通过校验，抛异常把</span></span><br><span class="line">    <span class="keyword">if</span> (!foundValid) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;Not able to find valid snapshots in &quot;</span> + snapDir);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 从最新的合法快照获得最新的zxid作为当前服务器的peerLastZxid</span></span><br><span class="line">    dt.lastProcessedZxid = Util.getZxidFromName(snap.getName(), SNAPSHOT_FILE_PREFIX);</span><br><span class="line">    <span class="keyword">return</span> dt.lastProcessedZxid;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// FileSnap#findNValidSnapshots()</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> List&lt;File&gt; <span class="title">findNValidSnapshots</span><span class="params">(<span class="keyword">int</span> n)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">// 这里根据文件明德后缀，也就是16进制的zxid排序</span></span><br><span class="line">    List&lt;File&gt; files = Util.sortDataDir(snapDir.listFiles(), SNAPSHOT_FILE_PREFIX, <span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">    List&lt;File&gt; list = <span class="keyword">new</span> ArrayList&lt;File&gt;();</span><br><span class="line">    <span class="keyword">for</span> (File f : files) &#123;</span><br><span class="line">        <span class="comment">// we should catch the exceptions</span></span><br><span class="line">        <span class="comment">// from the valid snapshot and continue</span></span><br><span class="line">        <span class="comment">// until we find a valid one</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 校验快照文件</span></span><br><span class="line">            <span class="keyword">if</span> (Util.isValidSnapshot(f)) &#123;</span><br><span class="line">                list.add(f);</span><br><span class="line">                count++;</span><br><span class="line">                <span class="keyword">if</span> (count == n) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            LOG.info(<span class="string">&quot;invalid snapshot &quot;</span> + f, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> list;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Util#isValidSnapshot()</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isValidSnapshot</span><span class="params">(File f)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">// 文件后缀如果等于-1说明文件非法</span></span><br><span class="line">    <span class="keyword">if</span> (f==<span class="keyword">null</span> || Util.getZxidFromName(f.getName(), FileSnap.SNAPSHOT_FILE_PREFIX) == -<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check for a valid snapshot</span></span><br><span class="line">    <span class="comment">// 获取只读文件</span></span><br><span class="line">    RandomAccessFile raf = <span class="keyword">new</span> RandomAccessFile(f, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// including the header and the last / bytes</span></span><br><span class="line">        <span class="comment">// the snapshot should be atleast 10 bytes</span></span><br><span class="line">        <span class="comment">// 文件头和最后的&quot;/&quot;加起来最少是个byte,少于10则非法</span></span><br><span class="line">        <span class="keyword">if</span> (raf.length() &lt; <span class="number">10</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 文件指针调到文件的最后五个字节的位置</span></span><br><span class="line">        raf.seek(raf.length() - <span class="number">5</span>);</span><br><span class="line">        <span class="keyword">byte</span> bytes[] = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">5</span>];</span><br><span class="line">        <span class="keyword">int</span> readlen = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> l;</span><br><span class="line">        <span class="comment">// 读取最后五个字节的数据</span></span><br><span class="line">        <span class="keyword">while</span>(readlen &lt; <span class="number">5</span> &amp;&amp;</span><br><span class="line">              (l = raf.read(bytes, readlen, bytes.length - readlen)) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            readlen += l;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 读到的数据长度不等于byte数组的长度，非法</span></span><br><span class="line">        <span class="keyword">if</span> (readlen != bytes.length) &#123;</span><br><span class="line">            LOG.info(<span class="string">&quot;Invalid snapshot &quot;</span> + f</span><br><span class="line">                    + <span class="string">&quot; too short, len = &quot;</span> + readlen);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ByteBuffer bb = ByteBuffer.wrap(bytes);</span><br><span class="line">        <span class="keyword">int</span> len = bb.getInt();</span><br><span class="line">        <span class="keyword">byte</span> b = bb.get();</span><br><span class="line">        <span class="comment">// 读到的内容长度不为1或者内容不为&quot;/&quot;，非法</span></span><br><span class="line">        <span class="comment">// 在写入快照时最后会写入path的值为&quot;/&quot;</span></span><br><span class="line">        <span class="keyword">if</span> (len != <span class="number">1</span> || b != <span class="string">&#x27;/&#x27;</span>) &#123;</span><br><span class="line">            LOG.info(<span class="string">&quot;Invalid snapshot &quot;</span> + f + <span class="string">&quot; len = &quot;</span> + len</span><br><span class="line">                    + <span class="string">&quot; byte = &quot;</span> + (b &amp; <span class="number">0xff</span>));</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        raf.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从上边看出，zookeeper会从文件系统读取至多100个快照文件，按照由新到旧排序，然后逐个解析，如果发现校验通过了，就不再校验其他的了，将最新的快照恢复到内存并从快照获得最新的zxid。</p>
<h2 id="处理事务日志"><a href="#处理事务日志" class="headerlink" title="处理事务日志"></a>处理事务日志</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FileTxnSnapLog#fastForwardFromEdits()</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">fastForwardFromEdits</span><span class="params">(DataTree dt, Map&lt;Long, Integer&gt; sessions,</span></span></span><br><span class="line"><span class="function"><span class="params">                                 PlayBackListener listener)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    FileTxnLog txnLog = <span class="keyword">new</span> FileTxnLog(dataDir);</span><br><span class="line">    <span class="comment">// 获得日志迭代器</span></span><br><span class="line">    TxnIterator itr = txnLog.read(dt.lastProcessedZxid+<span class="number">1</span>);</span><br><span class="line">    <span class="comment">// 当前最大的zxid</span></span><br><span class="line">    <span class="keyword">long</span> highestZxid = dt.lastProcessedZxid;</span><br><span class="line">    TxnHeader hdr;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="comment">// iterator points to</span></span><br><span class="line">            <span class="comment">// the first valid txn when initialized</span></span><br><span class="line">            hdr = itr.getHeader();</span><br><span class="line">            <span class="keyword">if</span> (hdr == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">//empty logs</span></span><br><span class="line">                <span class="keyword">return</span> dt.lastProcessedZxid;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (hdr.getZxid() &lt; highestZxid &amp;&amp; highestZxid != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// 事务日志中比当前datatree的zxid小的不理睬</span></span><br><span class="line">                LOG.error(<span class="string">&quot;&#123;&#125;(higestZxid) &gt; &#123;&#125;(next log) for type &#123;&#125;&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> Object[] &#123; highestZxid, hdr.getZxid(),</span><br><span class="line">                                hdr.getType() &#125;);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 大的则赋予给highestZxid</span></span><br><span class="line">                highestZxid = hdr.getZxid();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 处理事务</span></span><br><span class="line">                processTransaction(hdr,dt,sessions, itr.getTxn());</span><br><span class="line">            &#125; <span class="keyword">catch</span>(KeeperException.NoNodeException e) &#123;</span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;Failed to process transaction type: &quot;</span> +</span><br><span class="line">                     hdr.getType() + <span class="string">&quot; error: &quot;</span> + e.getMessage(), e);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 完成事务处理后，会触发日志加载完成的监听器</span></span><br><span class="line">            listener.onTxnLoaded(hdr, itr.getTxn());</span><br><span class="line">            <span class="keyword">if</span> (!itr.next())</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (itr != <span class="keyword">null</span>) &#123;</span><br><span class="line">            itr.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 返回最新的zxid</span></span><br><span class="line">    <span class="keyword">return</span> highestZxid;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// FileTxnLog#read()</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> TxnIterator <span class="title">read</span><span class="params">(<span class="keyword">long</span> zxid)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> FileTxnIterator(logDir, zxid);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// FileTxnLog$FileTxnIterator</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">FileTxnIterator</span><span class="params">(File logDir, <span class="keyword">long</span> zxid)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.logDir = logDir;</span><br><span class="line">    <span class="keyword">this</span>.zxid = zxid;</span><br><span class="line">    init();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// FileTxnLog$FileTxnIterator#init()</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    storedFiles = <span class="keyword">new</span> ArrayList&lt;File&gt;();</span><br><span class="line">    <span class="comment">// 按照文件后缀也就是zxid由大到小排序</span></span><br><span class="line">    List&lt;File&gt; files = Util.sortDataDir(FileTxnLog.getLogFiles(logDir.listFiles(), <span class="number">0</span>), LOG_FILE_PREFIX, <span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">for</span> (File f: files) &#123;</span><br><span class="line">        <span class="comment">// 大于最新的事务日志的文件加到集合</span></span><br><span class="line">        <span class="keyword">if</span> (Util.getZxidFromName(f.getName(), LOG_FILE_PREFIX) &gt;= zxid) &#123;</span><br><span class="line">            storedFiles.add(f);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 第一个小于最新的zxid（上边快照中获得）的日志文件也加到集合</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (Util.getZxidFromName(f.getName(), LOG_FILE_PREFIX) &lt; zxid) &#123;</span><br><span class="line">            storedFiles.add(f);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    goToNextLog();</span><br><span class="line">    <span class="keyword">if</span> (!next())</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">while</span> (hdr.getZxid() &lt; zxid) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!next())</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// FileTxnLog#processTransaction()</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processTransaction</span><span class="params">(TxnHeader hdr,DataTree dt,</span></span></span><br><span class="line"><span class="function"><span class="params">        Map&lt;Long, Integer&gt; sessions, Record txn)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> KeeperException.NoNodeException </span>&#123;</span><br><span class="line">    ProcessTxnResult rc;</span><br><span class="line">    <span class="keyword">switch</span> (hdr.getType()) &#123;</span><br><span class="line">    <span class="keyword">case</span> OpCode.createSession:</span><br><span class="line">        <span class="comment">// createSession类型的事务操作</span></span><br><span class="line">        sessions.put(hdr.getClientId(),</span><br><span class="line">                ((CreateSessionTxn) txn).getTimeOut());</span><br><span class="line">        <span class="keyword">if</span> (LOG.isTraceEnabled()) &#123;</span><br><span class="line">            ZooTrace.logTraceMessage(LOG,ZooTrace.SESSION_TRACE_MASK,</span><br><span class="line">                    <span class="string">&quot;playLog --- create session in log: 0x&quot;</span></span><br><span class="line">                            + Long.toHexString(hdr.getClientId())</span><br><span class="line">                            + <span class="string">&quot; with timeout: &quot;</span></span><br><span class="line">                            + ((CreateSessionTxn) txn).getTimeOut());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// give dataTree a chance to sync its lastProcessedZxid</span></span><br><span class="line">        rc = dt.processTxn(hdr, txn);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> OpCode.closeSession:</span><br><span class="line">        <span class="comment">// closeSession类型的事务操作</span></span><br><span class="line">        sessions.remove(hdr.getClientId());</span><br><span class="line">        <span class="keyword">if</span> (LOG.isTraceEnabled()) &#123;</span><br><span class="line">            ZooTrace.logTraceMessage(LOG,ZooTrace.SESSION_TRACE_MASK,</span><br><span class="line">                    <span class="string">&quot;playLog --- close session in log: 0x&quot;</span></span><br><span class="line">                            + Long.toHexString(hdr.getClientId()));</span><br><span class="line">        &#125;</span><br><span class="line">        rc = dt.processTxn(hdr, txn);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="comment">// 最终都是交由DataTree的processTxn方法处理事务</span></span><br><span class="line">        rc = dt.processTxn(hdr, txn);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (rc.err != Code.OK.intValue()) &#123;</span><br><span class="line">        LOG.debug(<span class="string">&quot;Ignoring processTxn failure hdr:&quot;</span> + hdr.getType()</span><br><span class="line">                + <span class="string">&quot;, error: &quot;</span> + rc.err + <span class="string">&quot;, path: &quot;</span> + rc.path);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ZKDatabase#commitProposalPlaybackListener</span></span><br><span class="line"><span class="comment">// 在fastForwardFromEdits方法中事务是一条一条处理，所以每次处理完一条事务就会触发这个listener,作用是将事务操作记录转换成Proposal，然后保存到ZKDatabase#committedLog队列中，以便Follower能快速同步</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> PlayBackListener commitProposalPlaybackListener = <span class="keyword">new</span> PlayBackListener() &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onTxnLoaded</span><span class="params">(TxnHeader hdr, Record txn)</span></span>&#123;</span><br><span class="line">        addCommittedProposal(hdr, txn);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// ZKDatabase#addCommittedProposal</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addCommittedProposal</span><span class="params">(TxnHeader hdr, Record txn)</span> </span>&#123;</span><br><span class="line">    Request r = <span class="keyword">new</span> Request(<span class="keyword">null</span>, <span class="number">0</span>, hdr.getCxid(), hdr.getType(), <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">    r.txn = txn;</span><br><span class="line">    r.hdr = hdr;</span><br><span class="line">    r.zxid = hdr.getZxid();</span><br><span class="line">    addCommittedProposal(r);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>QuorumPeer#loadDataBase</code>方法的后面会进行epoch的校验</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// QuorumPeer#loadDataBase()</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loadDataBase</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    File updating = <span class="keyword">new</span> File(getTxnFactory().getSnapDir(),</span><br><span class="line">                             UPDATING_EPOCH_FILENAME);</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">        zkDb.loadDataBase();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// load the epochs</span></span><br><span class="line">        <span class="keyword">long</span> lastProcessedZxid = zkDb.getDataTree().lastProcessedZxid;</span><br><span class="line">        <span class="comment">// 加载完快照和事务日志之后，从zxid获得最新epoch-leader的选举周期</span></span><br><span class="line">		    <span class="keyword">long</span> epochOfZxid = ZxidUtils.getEpochFromZxid(lastProcessedZxid);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="comment">// 从文件系统读取“currentepoch”文件，在快照目录下</span></span><br><span class="line">        	currentEpoch = readLongFromFile(CURRENT_EPOCH_FILENAME);</span><br><span class="line">            <span class="keyword">if</span> (epochOfZxid &gt; currentEpoch &amp;&amp; updating.exists()) &#123;</span><br><span class="line">                LOG.info(<span class="string">&quot;&#123;&#125; found. The server was terminated after &quot;</span> +</span><br><span class="line">                         <span class="string">&quot;taking a snapshot but before updating current &quot;</span> +</span><br><span class="line">                         <span class="string">&quot;epoch. Setting current epoch to &#123;&#125;.&quot;</span>,</span><br><span class="line">                         UPDATING_EPOCH_FILENAME, epochOfZxid);</span><br><span class="line">                <span class="comment">// 如果从事务日志恢复的epoch大于从文件读取的，就设置当前节点的epoch为大的</span></span><br><span class="line">                setCurrentEpoch(epochOfZxid);</span><br><span class="line">                <span class="keyword">if</span> (!updating.delete()) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;Failed to delete &quot;</span> +</span><br><span class="line">                                          updating.toString());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span>(FileNotFoundException e) &#123;</span><br><span class="line">        	<span class="comment">// pick a reasonable epoch number</span></span><br><span class="line">        	<span class="comment">// this should only happen once when moving to a</span></span><br><span class="line">        	<span class="comment">// new code version</span></span><br><span class="line">        	currentEpoch = epochOfZxid;</span><br><span class="line">        	LOG.info(CURRENT_EPOCH_FILENAME</span><br><span class="line">        	        + <span class="string">&quot; not found! Creating with a reasonable default of &#123;&#125;. This should only happen when you are upgrading your installation&quot;</span>,</span><br><span class="line">        	        currentEpoch);</span><br><span class="line">        	writeLongToFile(CURRENT_EPOCH_FILENAME, currentEpoch);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 经过上面的比较，此时二者应该相等，不等就非法</span></span><br><span class="line">        <span class="keyword">if</span> (epochOfZxid &gt; currentEpoch) &#123;</span><br><span class="line">        	<span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;The current epoch, &quot;</span> + ZxidUtils.zxidToString(currentEpoch) + <span class="string">&quot;, is older than the last zxid, &quot;</span> + lastProcessedZxid);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="comment">// 从文件系统的“acceptedEpoch”文件读取acceptedEpoch</span></span><br><span class="line">        	acceptedEpoch = readLongFromFile(ACCEPTED_EPOCH_FILENAME);</span><br><span class="line">        &#125; <span class="keyword">catch</span>(FileNotFoundException e) &#123;</span><br><span class="line">        	<span class="comment">// pick a reasonable epoch number</span></span><br><span class="line">        	<span class="comment">// this should only happen once when moving to a</span></span><br><span class="line">        	<span class="comment">// new code version</span></span><br><span class="line">        	acceptedEpoch = epochOfZxid;</span><br><span class="line">        	LOG.info(ACCEPTED_EPOCH_FILENAME</span><br><span class="line">        	        + <span class="string">&quot; not found! Creating with a reasonable default of &#123;&#125;. This should only happen when you are upgrading your installation&quot;</span>,</span><br><span class="line">        	        acceptedEpoch);</span><br><span class="line">        	writeLongToFile(ACCEPTED_EPOCH_FILENAME, acceptedEpoch);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果上次的epooch小于当前的，就非法</span></span><br><span class="line">        <span class="keyword">if</span> (acceptedEpoch &lt; currentEpoch) &#123;</span><br><span class="line">        	<span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;The accepted epoch, &quot;</span> + ZxidUtils.zxidToString(acceptedEpoch) + <span class="string">&quot; is less than the current epoch, &quot;</span> + ZxidUtils.zxidToString(currentEpoch));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span>(IOException ie) &#123;</span><br><span class="line">        LOG.error(<span class="string">&quot;Unable to load database on disk&quot;</span>, ie);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;Unable to run quorum server &quot;</span>, ie);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="数据同步"><a href="#数据同步" class="headerlink" title="数据同步"></a>数据同步</h1><h2 id="获得Learner状态"><a href="#获得Learner状态" class="headerlink" title="获得Learner状态"></a>获得Learner状态</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// LearnerHandler#run()</span></span><br><span class="line">    <span class="keyword">byte</span> ver[] = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">4</span>];</span><br><span class="line">    ByteBuffer.wrap(ver).putInt(<span class="number">0x10000</span>);</span><br><span class="line">    <span class="comment">// 将当前Leader的信息发送到Learner</span></span><br><span class="line">    QuorumPacket newEpochPacket = <span class="keyword">new</span> QuorumPacket(Leader.LEADERINFO, ZxidUtils.makeZxid(newEpoch, <span class="number">0</span>), ver, <span class="keyword">null</span>);</span><br><span class="line">    oa.writeRecord(newEpochPacket, <span class="string">&quot;packet&quot;</span>);</span><br><span class="line">    bufferedOutput.flush();</span><br><span class="line">    QuorumPacket ackEpochPacket = <span class="keyword">new</span> QuorumPacket();</span><br><span class="line">    <span class="comment">// 从Learner处获得返回信息ACK</span></span><br><span class="line">    ia.readRecord(ackEpochPacket, <span class="string">&quot;packet&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (ackEpochPacket.getType() != Leader.ACKEPOCH) &#123;</span><br><span class="line">        LOG.error(ackEpochPacket.toString()</span><br><span class="line">                + <span class="string">&quot; is not ACKEPOCH&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">// 获得返回信息Learner的epoch</span></span><br><span class="line">    ByteBuffer bbepoch = ByteBuffer.wrap(ackEpochPacket.getData());</span><br><span class="line">    ss = <span class="keyword">new</span> StateSummary(bbepoch.getInt(), ackEpochPacket.getZxid());</span><br><span class="line">    leader.waitForEpochAck(<span class="keyword">this</span>.getSid(), ss);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 获得Learner的最新zxid</span></span><br><span class="line">peerLastZxid = ss.getLastZxid();</span><br></pre></td></tr></table></figure>
<h2 id="数据同步初始化"><a href="#数据同步初始化" class="headerlink" title="数据同步初始化"></a>数据同步初始化</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* the default to send to the follower */</span></span><br><span class="line"><span class="comment">// 默认全量同步</span></span><br><span class="line"><span class="keyword">int</span> packetToSend = Leader.SNAP;</span><br><span class="line"><span class="keyword">long</span> zxidToSend = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">long</span> leaderLastZxid = <span class="number">0</span>;</span><br><span class="line"><span class="comment">/** the packets that the follower needs to get updates from **/</span></span><br><span class="line"><span class="keyword">long</span> updates = peerLastZxid;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* we are sending the diff check if we have proposals in memory to be able to</span></span><br><span class="line"><span class="comment"> * send a diff to the</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">ReentrantReadWriteLock lock = leader.zk.getZKDatabase().getLogLock();</span><br><span class="line">ReadLock rl = lock.readLock();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    rl.lock();       </span><br><span class="line">    <span class="comment">// 获得leader的内存数据库中提交过的最大zxid</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> maxCommittedLog = leader.zk.getZKDatabase().getmaxCommittedLog();</span><br><span class="line">    <span class="comment">// 获得leader的内存数据库中提交过的最小zxid</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> minCommittedLog = leader.zk.getZKDatabase().getminCommittedLog();</span><br><span class="line">    LOG.info(<span class="string">&quot;Synchronizing with Follower sid: &quot;</span> + sid</span><br><span class="line">            +<span class="string">&quot; maxCommittedLog=0x&quot;</span>+Long.toHexString(maxCommittedLog)</span><br><span class="line">            +<span class="string">&quot; minCommittedLog=0x&quot;</span>+Long.toHexString(minCommittedLog)</span><br><span class="line">            +<span class="string">&quot; peerLastZxid=0x&quot;</span>+Long.toHexString(peerLastZxid));</span><br><span class="line">    <span class="comment">// 获得leader的内存数据库中提交过的事务记录队列，上边事务日志恢复的时候PlayBackListener监听器将事务加载到这个队列中</span></span><br><span class="line">    LinkedList&lt;Proposal&gt; proposals = leader.zk.getZKDatabase().getCommittedLog();</span><br></pre></td></tr></table></figure>
<h2 id="同步"><a href="#同步" class="headerlink" title="同步"></a>同步</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// LearnerHandler#run()</span></span><br><span class="line">    <span class="keyword">if</span> (peerLastZxid == leader.zk.getZKDatabase().getDataTreeLastProcessedZxid()) &#123;</span><br><span class="line">        <span class="comment">// Follower is already sync with us, send empty diff</span></span><br><span class="line">        <span class="comment">// leader内存数据库中最新的zxid与learner的zxid一致，就标记空的DIFF同步方式</span></span><br><span class="line">        LOG.info(<span class="string">&quot;leader and follower are in sync, zxid=0x&#123;&#125;&quot;</span>,</span><br><span class="line">                Long.toHexString(peerLastZxid));</span><br><span class="line">        packetToSend = Leader.DIFF;</span><br><span class="line">        zxidToSend = peerLastZxid;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (proposals.size() != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 如果从事务日志加载进来的事务日志队列不为空</span></span><br><span class="line">        LOG.debug(<span class="string">&quot;proposal size is &#123;&#125;&quot;</span>, proposals.size());</span><br><span class="line">        <span class="keyword">if</span> ((maxCommittedLog &gt;= peerLastZxid)</span><br><span class="line">                &amp;&amp; (minCommittedLog &lt;= peerLastZxid)) &#123;</span><br><span class="line">            LOG.debug(<span class="string">&quot;Sending proposals to follower&quot;</span>);</span><br><span class="line">            <span class="comment">// 如果learner的zxid在leader的最大zxid和最小zxid之间，说明存在数据差距，要进行同步</span></span><br><span class="line">            <span class="comment">// as we look through proposals, this variable keeps track of previous</span></span><br><span class="line">            <span class="comment">// proposal Id.</span></span><br><span class="line">            <span class="keyword">long</span> prevProposalZxid = minCommittedLog;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Keep track of whether we are about to send the first packet.</span></span><br><span class="line">            <span class="comment">// Before sending the first packet, we have to tell the learner</span></span><br><span class="line">            <span class="comment">// whether to expect a trunc or a diff</span></span><br><span class="line">            <span class="keyword">boolean</span> firstPacket=<span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If we are here, we can use committedLog to sync with</span></span><br><span class="line">            <span class="comment">// follower. Then we only need to decide whether to</span></span><br><span class="line">            <span class="comment">// send trunc or not</span></span><br><span class="line">            packetToSend = Leader.DIFF;</span><br><span class="line">            zxidToSend = maxCommittedLog;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (Proposal propose: proposals) &#123;</span><br><span class="line">                <span class="comment">// skip the proposals the peer already has</span></span><br><span class="line">                <span class="keyword">if</span> (propose.packet.getZxid() &lt;= peerLastZxid) &#123;</span><br><span class="line">                    <span class="comment">// leader的zxid小于等于learner的部分，跳过</span></span><br><span class="line">                    prevProposalZxid = propose.packet.getZxid();</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// If we are sending the first packet, figure out whether to trunc</span></span><br><span class="line">                    <span class="comment">// in case the follower has some proposals that the leader doesn&#x27;t</span></span><br><span class="line">                    <span class="keyword">if</span> (firstPacket) &#123;</span><br><span class="line">                        firstPacket = <span class="keyword">false</span>;</span><br><span class="line">                        <span class="comment">// Does the peer have some proposals that the leader hasn&#x27;t seen yet</span></span><br><span class="line">                        <span class="keyword">if</span> (prevProposalZxid &lt; peerLastZxid) &#123;</span><br><span class="line">                            <span class="comment">// send a trunc message before sending the diff</span></span><br><span class="line">                            <span class="comment">// 如果发现leader的zxid小于learner的，就标记learner回滚到和leader一致</span></span><br><span class="line">                            packetToSend = Leader.TRUNC;     </span><br><span class="line">                            <span class="comment">// 回滚到prevProposalZxid                           </span></span><br><span class="line">                            zxidToSend = prevProposalZxid;</span><br><span class="line">                            updates = zxidToSend;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 先发送事务记录</span></span><br><span class="line">                    queuePacket(propose.packet);</span><br><span class="line">                    QuorumPacket qcommit = <span class="keyword">new</span> QuorumPacket(Leader.COMMIT, propose.packet.getZxid(),</span><br><span class="line">                            <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">                    <span class="comment">// 再发送提交命令，让learner提交事务</span></span><br><span class="line">                    queuePacket(qcommit);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (peerLastZxid &gt; maxCommittedLog) &#123;</span><br><span class="line">            LOG.debug(<span class="string">&quot;Sending TRUNC to follower zxidToSend=0x&#123;&#125; updates=0x&#123;&#125;&quot;</span>,</span><br><span class="line">                    Long.toHexString(maxCommittedLog),</span><br><span class="line">                    Long.toHexString(updates));</span><br><span class="line">            <span class="comment">// 如果事务记录的队列不为空，且learner的zxid大于leader的zxid,就标记learner回滚</span></span><br><span class="line">            packetToSend = Leader.TRUNC;</span><br><span class="line">            <span class="comment">// 回滚到maxCommittedLog</span></span><br><span class="line">            zxidToSend = maxCommittedLog;</span><br><span class="line">            updates = zxidToSend;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            LOG.warn(<span class="string">&quot;Unhandled proposal scenario&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// just let the state transfer happen</span></span><br><span class="line">        LOG.debug(<span class="string">&quot;proposals is empty&quot;</span>);</span><br><span class="line">    &#125;               </span><br><span class="line"></span><br><span class="line">    LOG.info(<span class="string">&quot;Sending &quot;</span> + Leader.getPacketType(packetToSend));</span><br><span class="line">    <span class="comment">// 获得最新的zxid</span></span><br><span class="line">    leaderLastZxid = leader.startForwarding(<span class="keyword">this</span>, updates);</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    rl.unlock();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看下startForwarding方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Leader#startForwarding()</span></span><br><span class="line"><span class="function"><span class="keyword">synchronized</span> <span class="keyword">public</span> <span class="keyword">long</span> <span class="title">startForwarding</span><span class="params">(LearnerHandler handler,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">long</span> lastSeenZxid)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Queue up any outstanding requests enabling the receipt of</span></span><br><span class="line">    <span class="comment">// new requests</span></span><br><span class="line">    <span class="keyword">if</span> (lastProposed &gt; lastSeenZxid) &#123;</span><br><span class="line">        <span class="comment">// toBeApplied队列，用来存储那些已经被CommitProcessor处理过的可被提交的Proposal</span></span><br><span class="line">        <span class="keyword">for</span> (Proposal p : toBeApplied) &#123;</span><br><span class="line">            <span class="keyword">if</span> (p.packet.getZxid() &lt;= lastSeenZxid) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            handler.queuePacket(p.packet);</span><br><span class="line">            <span class="comment">// Since the proposal has been committed we need to send the</span></span><br><span class="line">            <span class="comment">// commit message also</span></span><br><span class="line">            QuorumPacket qp = <span class="keyword">new</span> QuorumPacket(Leader.COMMIT, p.packet</span><br><span class="line">                    .getZxid(), <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">            handler.queuePacket(qp);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Only participant need to get outstanding proposals</span></span><br><span class="line">        <span class="comment">// outstandingProposals是事务投票箱，同意事物的follower的proposal的ackSet会有sid用来过半统计</span></span><br><span class="line">        <span class="comment">// 投票箱有数据说明有事务，所以要处理</span></span><br><span class="line">        <span class="keyword">if</span> (handler.getLearnerType() == LearnerType.PARTICIPANT) &#123;</span><br><span class="line">            List&lt;Long&gt;zxids = <span class="keyword">new</span> ArrayList&lt;Long&gt;(outstandingProposals.keySet());</span><br><span class="line">            Collections.sort(zxids);</span><br><span class="line">            <span class="keyword">for</span> (Long zxid: zxids) &#123;</span><br><span class="line">                <span class="keyword">if</span> (zxid &lt;= lastSeenZxid) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                handler.queuePacket(outstandingProposals.get(zxid).packet);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (handler.getLearnerType() == LearnerType.PARTICIPANT) &#123;</span><br><span class="line">        <span class="comment">// 将当前follower注册到leader</span></span><br><span class="line">        addForwardingFollower(handler);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 将当前observer注册到leader</span></span><br><span class="line">        addObserverLearnerHandler(handler);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 经过上边的对toBeApplied队列和outstandingProposals投票箱的处理，如果发现更新的zxid就获得这个新的zxid</span></span><br><span class="line">    <span class="keyword">return</span> lastProposed;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>后续操作</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// LearnerHandler#run()</span></span><br><span class="line">QuorumPacket newLeaderQP = <span class="keyword">new</span> QuorumPacket(Leader.NEWLEADER,</span><br><span class="line">                    ZxidUtils.makeZxid(newEpoch, <span class="number">0</span>), <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line"> <span class="keyword">if</span> (getVersion() &lt; <span class="number">0x10000</span>) &#123;</span><br><span class="line">    oa.writeRecord(newLeaderQP, <span class="string">&quot;packet&quot;</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// leader发送一个NEWLEADER指令，用于通知learner已经将提议缓存队列中的proposal都同步给自己了。</span></span><br><span class="line">    queuedPackets.add(newLeaderQP);</span><br><span class="line">&#125;</span><br><span class="line">bufferedOutput.flush();</span><br><span class="line"><span class="comment">//Need to set the zxidToSend to the latest zxid</span></span><br><span class="line"><span class="keyword">if</span> (packetToSend == Leader.SNAP) &#123;</span><br><span class="line">    zxidToSend = leader.zk.getZKDatabase().getDataTreeLastProcessedZxid();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 根据上边minCommittedLog、maxCommittedLog、peerLastZxid、prevProposalZxid的对比，发送TRUNC、DIFF或者SNAP同步消息</span></span><br><span class="line">oa.writeRecord(<span class="keyword">new</span> QuorumPacket(packetToSend, zxidToSend, <span class="keyword">null</span>, <span class="keyword">null</span>), <span class="string">&quot;packet&quot;</span>);</span><br><span class="line">bufferedOutput.flush();</span><br><span class="line"></span><br><span class="line"><span class="comment">/* if we are not truncating or sending a diff just send a snapshot */</span></span><br><span class="line"><span class="comment">// 如果没有DIFF或者TRUNC方式同步，就全量同步SNAP</span></span><br><span class="line"><span class="keyword">if</span> (packetToSend == Leader.SNAP) &#123;</span><br><span class="line">    LOG.info(<span class="string">&quot;Sending snapshot last zxid of peer is 0x&quot;</span></span><br><span class="line">            + Long.toHexString(peerLastZxid) + <span class="string">&quot; &quot;</span></span><br><span class="line">            + <span class="string">&quot; zxid of leader is 0x&quot;</span></span><br><span class="line">            + Long.toHexString(leaderLastZxid)</span><br><span class="line">            + <span class="string">&quot;sent zxid of db as 0x&quot;</span></span><br><span class="line">            + Long.toHexString(zxidToSend));</span><br><span class="line">    <span class="comment">// Dump data to peer</span></span><br><span class="line">    leader.zk.getZKDatabase().serializeSnapshot(oa);</span><br><span class="line">    oa.writeString(<span class="string">&quot;BenWasHere&quot;</span>, <span class="string">&quot;signature&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">bufferedOutput.flush();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Start sending packets</span></span><br><span class="line"><span class="comment">// 异步发同步包</span></span><br><span class="line"><span class="keyword">new</span> Thread() &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Thread.currentThread().setName(</span><br><span class="line">                <span class="string">&quot;Sender-&quot;</span> + sock.getRemoteSocketAddress());</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            sendPackets();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            LOG.warn(<span class="string">&quot;Unexpected interruption&quot;</span>,e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;.start();</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Have to wait for the first ACK, wait until</span></span><br><span class="line"><span class="comment"> * the leader is ready, and only then we can</span></span><br><span class="line"><span class="comment"> * start processing messages.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="comment">// 接收follower的对同步数据的响应ack</span></span><br><span class="line">qp = <span class="keyword">new</span> QuorumPacket();</span><br><span class="line">ia.readRecord(qp, <span class="string">&quot;packet&quot;</span>);</span><br><span class="line"><span class="keyword">if</span>(qp.getType() != Leader.ACK)&#123;</span><br><span class="line">    LOG.error(<span class="string">&quot;Next packet was supposed to be an ACK&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line">LOG.info(<span class="string">&quot;Received NEWLEADER-ACK message from &quot;</span> + getSid());</span><br><span class="line"><span class="comment">// 等待NEWLEADER消息的响应ACK也是过半策略等待的</span></span><br><span class="line">leader.waitForNewLeaderAck(getSid(), qp.getZxid());</span><br><span class="line"></span><br><span class="line"><span class="comment">// 同步检查标记为已开始，标记之后，可以对事务提案进行更新操作updateProposal</span></span><br><span class="line">syncLimitCheck.start();</span><br><span class="line"></span><br><span class="line"><span class="comment">// now that the ack has been processed expect the syncLimit</span></span><br><span class="line"><span class="comment">// 设置socket的SoTimeout</span></span><br><span class="line">sock.setSoTimeout(leader.self.tickTime * leader.self.syncLimit);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Wait until leader starts up</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// 等待20ms启动leader</span></span><br><span class="line"><span class="keyword">synchronized</span>(leader.zk)&#123;</span><br><span class="line">    <span class="keyword">while</span>(!leader.zk.isRunning() &amp;&amp; !<span class="keyword">this</span>.isInterrupted())&#123;</span><br><span class="line">        leader.zk.wait(<span class="number">20</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Mutation packets will be queued during the serialize,</span></span><br><span class="line"><span class="comment">// so we need to mark when the peer can actually start</span></span><br><span class="line"><span class="comment">// using the data</span></span><br><span class="line"><span class="comment">// leader向所有已完成数据同步的learner发送一个UPTODATE指令，用来通知learner已完成数据同步，同时集群已有过半机器完成同步，集群已具有对外服务的能力了。</span></span><br><span class="line">queuedPackets.add(<span class="keyword">new</span> QuorumPacket(Leader.UPTODATE, -<span class="number">1</span>, <span class="keyword">null</span>, <span class="keyword">null</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 下边集群对外提供服务</span></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Learner#syncWithLeader()</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">syncWithLeader</span><span class="params">(<span class="keyword">long</span> newLeaderZxid)</span> <span class="keyword">throws</span> IOException, InterruptedException</span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">synchronized</span> (zk) &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">boolean</span> isPreZAB1_0 = <span class="keyword">true</span>;</span><br><span class="line">        <span class="comment">//If we are not going to take the snapshot be sure the transactions are not applied in memory</span></span><br><span class="line">        <span class="comment">// but written out to the transaction log</span></span><br><span class="line">        <span class="keyword">boolean</span> writeToTxnLog = !snapshotNeeded;</span><br><span class="line">        <span class="comment">// we are now going to start getting transactions to apply followed by an UPTODATE</span></span><br><span class="line">        outerLoop:</span><br><span class="line">        <span class="keyword">while</span> (self.isRunning()) &#123;</span><br><span class="line">            readPacket(qp);</span><br><span class="line">            <span class="keyword">switch</span>(qp.getType()) &#123;</span><br><span class="line">            ...</span><br><span class="line">            <span class="keyword">case</span> Leader.UPTODATE:</span><br><span class="line">                <span class="comment">// leader发送UPTODATE消息后，follower处理</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// 在Zab V1.0（ZK 3.4+）中，我们可以在获取NEWLEADER消息时拍摄快照，但是在V1.0之前我们在UPDATE消息上拍摄快照，我们需要确保我们不会拍摄两次快照。</span></span><br><span class="line">                <span class="keyword">if</span> (isPreZAB1_0) &#123;</span><br><span class="line">                    zk.takeSnapshot();</span><br><span class="line">                    self.setCurrentEpoch(newEpoch);</span><br><span class="line">                &#125;</span><br><span class="line">                self.cnxnFactory.setZooKeeperServer(zk);                </span><br><span class="line">                <span class="keyword">break</span> outerLoop;</span><br><span class="line">            ...</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Follower#processPacket()</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">processPacket</span><span class="params">(QuorumPacket qp)</span> <span class="keyword">throws</span> IOException</span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (qp.getType()) &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">case</span> Leader.UPTODATE:</span><br><span class="line">        <span class="comment">// 正常服务阶段</span></span><br><span class="line">        <span class="comment">// follower在接收到leader发来的UPTODATE消息会打印日志，别的没了</span></span><br><span class="line">        LOG.error(<span class="string">&quot;Received an UPTODATE message after Follower started&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        LOG.error(<span class="string">&quot;Invalid packet type: &#123;&#125; received by Observer&quot;</span>, qp.getType());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ok，就到这</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2018/09/17/zookeeper%E6%95%B0%E6%8D%AE%E4%B8%8E%E5%AD%98%E5%82%A8/" data-id="ckjr4ve0y009jf0uk9mwe7y2s" data-title="zookeeper数据与存储" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/zookeeper/" rel="tag">zookeeper</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-zookeeper服务器角色" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2018/09/09/zookeeper%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%A7%92%E8%89%B2/" class="article-date">
  <time class="dt-published" datetime="2018-09-09T13:06:04.000Z" itemprop="datePublished">2018-09-09</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/zookeeper/">zookeeper</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2018/09/09/zookeeper%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%A7%92%E8%89%B2/">zookeeper服务器角色</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Leader"><a href="#Leader" class="headerlink" title="Leader"></a>Leader</h1><p>Leader服务器是Zookeeper集群工作的核心，其主要工作如下</p>
<ul>
<li> 事务请求的唯一调度和处理者，保证集群事务处理的顺序性。</li>
<li> 集群内部各服务器的调度者。</li>
</ul>
<h2 id="请求处理器链"><a href="#请求处理器链" class="headerlink" title="请求处理器链"></a>请求处理器链</h2><p><img src="http://file.ornobug.top/zookeeper_leader%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86%E5%99%A8%E9%93%BE.png" alt="leader请求处理器链" title="leader请求处理器链"></p>
        
          <p class="article-more-link">
            <a href="/2018/09/09/zookeeper%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%A7%92%E8%89%B2/#more">Read More</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2018/09/09/zookeeper%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%A7%92%E8%89%B2/" data-id="ckjr4vdzf002sf0uk659g0rqr" data-title="zookeeper服务器角色" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/zookeeper/" rel="tag">zookeeper</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-轮子系列todo" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2018/09/09/%E8%BD%AE%E5%AD%90%E7%B3%BB%E5%88%97todo/" class="article-date">
  <time class="dt-published" datetime="2018-09-09T13:06:04.000Z" itemprop="datePublished">2018-09-09</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E8%BD%AE%E5%AD%90/">轮子</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2018/09/09/%E8%BD%AE%E5%AD%90%E7%B3%BB%E5%88%97todo/">轮子系列todo</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <ul>
<li><input disabled="" type="checkbox"> 自己实现一个spring</li>
<li><input disabled="" type="checkbox"> 自己实现一个mybatis</li>
<li><input disabled="" type="checkbox"> 自己实现一个数据库连接池</li>
<li><input disabled="" type="checkbox"> 自己实现一个简单的分布式服务框架</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2018/09/09/%E8%BD%AE%E5%AD%90%E7%B3%BB%E5%88%97todo/" data-id="ckjr4vdzw004mf0uk1clc8v1y" data-title="轮子系列todo" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E8%BD%AE%E5%AD%90/" rel="tag">轮子</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-zookeeper选举源码实现" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2018/09/05/zookeeper%E9%80%89%E4%B8%BE%E6%BA%90%E7%A0%81%E5%AE%9E%E7%8E%B0/" class="article-date">
  <time class="dt-published" datetime="2018-09-05T13:06:04.000Z" itemprop="datePublished">2018-09-05</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/zookeeper/">zookeeper</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2018/09/05/zookeeper%E9%80%89%E4%B8%BE%E6%BA%90%E7%A0%81%E5%AE%9E%E7%8E%B0/">zookeeper选举源码实现</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="服务器状态"><a href="#服务器状态" class="headerlink" title="服务器状态"></a>服务器状态</h1><ul>
<li>LOOKING:寻找Leader的状态。当机器处于该状态时，他认为集群中没有Leader，会进入选举流程</li>
<li>FOLLOWING:跟随者状态，表明当前服务器角色是Follower</li>
<li>Leading:领导者状态，表明当前机器是Leader</li>
<li>OBSERVER:观察者状态，表明当前机器角色是Observer</li>
</ul>
        
          <p class="article-more-link">
            <a href="/2018/09/05/zookeeper%E9%80%89%E4%B8%BE%E6%BA%90%E7%A0%81%E5%AE%9E%E7%8E%B0/#more">Read More</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2018/09/05/zookeeper%E9%80%89%E4%B8%BE%E6%BA%90%E7%A0%81%E5%AE%9E%E7%8E%B0/" data-id="ckjr4ve0w009af0uk0d01ea2j" data-title="zookeeper选举源码实现" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/zookeeper/" rel="tag">zookeeper</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-zookeeper选举概述" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2018/09/04/zookeeper%E9%80%89%E4%B8%BE%E6%A6%82%E8%BF%B0/" class="article-date">
  <time class="dt-published" datetime="2018-09-04T13:06:04.000Z" itemprop="datePublished">2018-09-04</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/zookeeper/">zookeeper</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2018/09/04/zookeeper%E9%80%89%E4%B8%BE%E6%A6%82%E8%BF%B0/">zookeeper选举概述</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="选举过程"><a href="#选举过程" class="headerlink" title="选举过程"></a>选举过程</h1><h2 id="启动期选举"><a href="#启动期选举" class="headerlink" title="启动期选举"></a>启动期选举</h2><p>若进行Leader选举，则至少需要两台机器，这里选取3台机器组成的服务器集群为例。在集群初始化阶段，当有一台服务器Server1启动时，其单独无法进行和完成Leader选举，当第二台服务器Server2启动时，此时两台机器可以相互通信，每台机器都试图找到Leader，于是进入Leader选举过程。选举过程如下:</p>
<ul>
<li><p><strong>每个Server发出一个投票</strong>。由于是初始情况，Server1和Server2都会将自己作为Leader服务器来进行投票，每次投票会包含所推举的服务器的myid和ZXID，使用(myid, ZXID)来表示，此时Server1的投票为(1, 0)，Server2的投票为(2, 0)，然后各自将这个投票发给集群中其他机器。</p>
</li>
<li><p><strong>接受来自各个服务器的投票</strong>。集群的每个服务器收到投票后，首先判断该投票的有效性，如检查是否是本轮投票、是否来自LOOKING状态的服务器。</p>
</li>
<li><p><strong>处理投票</strong>。针对每一个投票，服务器都需要将别人的投票和自己的投票进行PK，PK规则如下</p>
<ul>
<li><p>优先检查ZXID。ZXID比较大的服务器优先作为Leader。</p>
</li>
<li><p>如果ZXID相同，那么就比较myid。myid较大的服务器作为Leader服务器。</p>
<p>对于Server1而言，它的投票是(1, 0)，接收Server2的投票为(2, 0)，首先会比较两者的ZXID，均为0，再比较myid，此时Server2的myid最大，于是更新自己的投票为(2, 0)，然后重新投票，对于Server2而言，其无须更新自己的投票，只是再次向集群中所有机器发出上一次投票信息即可。</p>
</li>
</ul>
</li>
<li><p><strong>统计投票</strong>。每次投票后，服务器都会统计投票信息，判断是否已经有过半机器接受到相同的投票信息，对于Server1、Server2而言，都统计出集群中已经有两台机器接受了(2, 0)的投票信息，此时便认为已经选出了Leader。</p>
</li>
<li><p><strong>改变服务器状态</strong>。一旦确定了Leader，每个服务器就会更新自己的状态，如果是Follower，那么就变更为FOLLOWING，如果是Leader，就变更为LEADING。</p>
</li>
</ul>
<h2 id="运行期选举"><a href="#运行期选举" class="headerlink" title="运行期选举"></a>运行期选举</h2><p>在Zookeeper运行期间，Leader与非Leader服务器各司其职，即便当有非Leader服务器宕机或新加入，此时也不会影响Leader，但是一旦Leader服务器挂了，那么整个集群将暂停对外服务，进入新一轮Leader选举，其过程和启动时期的Leader选举过程基本一致。假设正在运行的有Server1、Server2、Server3三台服务器，当前Leader是Server2，若某一时刻Leader挂了，此时便开始Leader选举。选举过程如下</p>
<ul>
<li><strong>变更状态</strong>。Leader挂后，余下的非Observer服务器都会讲自己的服务器状态变更为LOOKING，然后开始进入Leader选举过程。</li>
<li><strong>每个Server会发出一个投票</strong>。在运行期间，每个服务器上的ZXID可能不同，此时假定Server1的ZXID为123，Server3的ZXID为122；在第一轮投票中，Server1和Server3都会投自己，产生投票(1, 123)，(3, 122)，然后各自将投票发送给集群中所有机器。</li>
<li><strong>接收来自各个服务器的投票</strong>。与启动时过程相同。</li>
<li><strong>处理投票</strong>。与启动时过程相同，此时，Server1将会成为Leader。</li>
<li><strong>统计投票</strong>。与启动时过程相同。</li>
<li><strong>改变服务器的状态</strong>。与启动时过程相同。</li>
</ul>
<h1 id="选举算法"><a href="#选举算法" class="headerlink" title="选举算法"></a>选举算法</h1><p>在3.4.0后的Zookeeper的版本只保留了TCP版本的FastLeaderElection选举算法。当一台机器进入Leader选举时，当前集群可能会处于以下两种状态</p>
<ul>
<li>集群中已经存在Leader。</li>
<li>集群中不存在Leader。<h2 id="术语解释"><a href="#术语解释" class="headerlink" title="术语解释"></a>术语解释</h2></li>
<li>SID:机器的唯一编号，在data目录的myid中指定</li>
<li>ZXID:事务ID，表示一次服务器状态的变更</li>
<li>Vote:投票</li>
<li>Quorum:过半数机器，在集群没有配置权重时，就是简单的机器数量过一半就行；配置权重后，要集群权重过一半</li>
<li>Epoch:选举的轮数，即逻辑时钟。随着选举的轮数++</li>
<li>Server状态:LOOKING,FOLLOWING,OBSERVING,LEADING<br>对于集群中已经存在Leader而言，此种情况一般都是某台机器启动得较晚，在其启动之前，集群已经在正常工作，对这种情况，该机器试图去选举Leader时，会被告知当前服务器的Leader信息，对于该机器而言，仅仅需要和Leader机器建立起连接，并进行状态同步即可。而在集群中不存在Leader情况下则会相对复杂，其步骤如下<h2 id="第一次投票"><a href="#第一次投票" class="headerlink" title="第一次投票"></a>第一次投票</h2>无论哪种导致进行Leader选举，集群的所有机器都处于试图选举出一个Leader的状态，即LOOKING状态，LOOKING机器会向所有其他机器发送消息，该消息称为投票。投票中包含了SID（服务器的唯一标识）和ZXID（事务ID），(SID, ZXID)形式来标识一次投票信息。假定Zookeeper由5台机器组成，SID分别为1、2、3、4、5，ZXID分别为9、9、9、8、8，并且此时SID为2的机器是Leader机器，某一时刻，1、2所在机器出现故障，因此集群开始进行Leader选举。在第一次投票时，每台机器都会将自己作为投票对象，于是SID为3、4、5的机器投票情况分别为(3, 9)，(4, 8)， (5, 8)。</li>
</ul>
<h2 id="变更投票"><a href="#变更投票" class="headerlink" title="变更投票"></a>变更投票</h2><p>每台机器发出投票后，也会收到其他机器的投票，每台机器会根据一定规则来处理收到的其他机器的投票，并以此来决定是否需要变更自己的投票，这个规则也是整个Leader选举算法的核心所在，其中术语描述如下</p>
<ul>
<li><strong>vote_sid</strong>：接收到的投票中所推举Leader服务器的SID。</li>
<li><strong>vote_zxid</strong>：接收到的投票中所推举Leader服务器的ZXID。</li>
<li><strong>self_sid</strong>：当前服务器自己的SID。</li>
<li><strong>self_zxid</strong>：当前服务器自己的ZXID。<br>每次对收到的投票的处理，都是对(vote_sid, vote_zxid)和(self_sid, self_zxid)对比的过程。</li>
<li><strong>规则一</strong>：如果vote_zxid大于self_zxid，就认可当前收到的投票，并再次将该投票发送出去。</li>
<li><strong>规则二</strong>：如果vote_zxid小于self_zxid，那么坚持自己的投票，不做任何变更。</li>
<li><strong>规则三</strong>：如果vote_zxid等于self_zxid，那么就对比两者的SID，如果vote_sid大于self_sid，那么就认可当前收到的投票，并再次将该投票发送出去。</li>
<li><strong>规则四</strong>：如果vote_zxid等于self_zxid，并且vote_sid小于self_sid，那么坚持自己的投票，不做任何变更。<br>结合上面规则，给出下面的集群变更过程。</li>
</ul>
<p><img src="http://file.ornobug.top/zookeeper%E9%9B%86%E7%BE%A4%E5%8F%98%E6%9B%B4%E8%BF%87%E7%A8%8B.png" alt="zookeeper集群变更" title="zookeeper集群变更"></p>
<h2 id="确定Leader"><a href="#确定Leader" class="headerlink" title="确定Leader"></a>确定Leader</h2><p>经过第二轮投票后，集群中的每台机器都会再次接收到其他机器的投票，然后开始统计投票，如果一台机器收到了超过半数的相同投票，那么这个投票对应的SID机器即为Leader。此时Server3将成为Leader。</p>
<p>由上面规则可知，通常那台服务器上的数据越新（ZXID会越大），其成为Leader的可能性越大，也就越能够保证数据的恢复。如果ZXID相同，则SID越大机会越大。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2018/09/04/zookeeper%E9%80%89%E4%B8%BE%E6%A6%82%E8%BF%B0/" data-id="ckjr4vdzl003cf0uk1pf22q95" data-title="zookeeper选举概述" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/zookeeper/" rel="tag">zookeeper</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-zookeeper单机服务启动流程" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2018/09/03/zookeeper%E5%8D%95%E6%9C%BA%E6%9C%8D%E5%8A%A1%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/" class="article-date">
  <time class="dt-published" datetime="2018-09-03T13:06:04.000Z" itemprop="datePublished">2018-09-03</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/zookeeper/">zookeeper</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2018/09/03/zookeeper%E5%8D%95%E6%9C%BA%E6%9C%8D%E5%8A%A1%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/">zookeeper单机服务启动流程</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="前置配置"><a href="#前置配置" class="headerlink" title="前置配置"></a>前置配置</h1><p><code>QuorumPeerMain</code>主方法参数args的第一个值为配置文件路径</p>
<p><img src="http://file.ornobug.top/zookeeper%E5%90%AF%E5%8A%A8%E9%85%8D%E7%BD%AE.png" alt="zookeeper启动配置" title="zookeeper启动配置"></p>
<p>还有一点要注意的是，直接把zookeeper源码<code>git clone</code>之后<code>ant eclipse</code>，然后倒入idea直接运行，会发现没有日志打印，解决方式如下</p>
<p><img src="http://file.ornobug.top/zookeeper%E6%BA%90%E7%A0%81%E5%90%AF%E5%8A%A8%E6%97%A5%E5%BF%97%E9%85%8D%E7%BD%AE.png" alt="zookeeper源码启动日志配置" title="zookeeper源码启动日志配置"></p>
<p>这里要把<code>log4j1.2.17.jar</code>拷贝到<code>src/java/lib</code>目录下，然后把<code>conf/log4j.properties</code>文件拷贝到图中新建的<code>resources</code>目录下，然后把<code>resources</code>标记为资源目录，如图</p>
<p><img src="http://file.ornobug.top/zookeeper%E6%BA%90%E7%A0%81%E5%90%AF%E5%8A%A8%E6%97%A5%E5%BF%97%E9%85%8D%E7%BD%AE-2.png" alt="zookeeper源码启动日志配置" title="zookeeper源码启动日志配置"></p>
<h1 id="服务端架构"><a href="#服务端架构" class="headerlink" title="服务端架构"></a>服务端架构</h1><p><img src="http://file.ornobug.top/zookeeper%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%9E%B6%E6%9E%84%E5%9B%BE.png" alt="zookeeper服务端架构图" title="zookeeper服务端架构图"></p>
<h1 id="启动流程"><a href="#启动流程" class="headerlink" title="启动流程"></a>启动流程</h1><p><img src="http://file.ornobug.top/zookeeper%E5%8D%95%E6%9C%BA%E6%9C%8D%E5%8A%A1%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%9B%BE.png" alt="zookeeper单机服务启动流程图" title="zookeeper单机服务启动流程图"></p>
<h1 id="预启动"><a href="#预启动" class="headerlink" title="预启动"></a>预启动</h1><p>ok 接下来看代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// QuorumPeerMain#main()</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 初始化启动类</span></span><br><span class="line">    QuorumPeerMain main = <span class="keyword">new</span> QuorumPeerMain();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        main.initializeAndRun(args);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">       ...</span><br><span class="line">    &#125;</span><br><span class="line">    LOG.info(<span class="string">&quot;Exiting normally&quot;</span>);</span><br><span class="line">    System.exit(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// QuorumPeerMain#initializeAndRun()</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initializeAndRun</span><span class="params">(String[] args)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> ConfigException, IOException</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    QuorumPeerConfig config = <span class="keyword">new</span> QuorumPeerConfig();</span><br><span class="line">    <span class="keyword">if</span> (args.length == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// 解析zoo.cfg文件</span></span><br><span class="line">        config.parse(args[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Start and schedule the the purge task</span></span><br><span class="line">    <span class="comment">// 开启定时清理历史数据文件</span></span><br><span class="line">    DatadirCleanupManager purgeMgr = <span class="keyword">new</span> DatadirCleanupManager(config</span><br><span class="line">            .getDataDir(), config.getDataLogDir(), config</span><br><span class="line">            .getSnapRetainCount(), config.getPurgeInterval());</span><br><span class="line">    purgeMgr.start();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 判断单机还是集群</span></span><br><span class="line">    <span class="keyword">if</span> (args.length == <span class="number">1</span> &amp;&amp; config.servers.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        runFromConfig(config);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        LOG.warn(<span class="string">&quot;Either no config or no quorum defined in config, running &quot;</span></span><br><span class="line">                + <span class="string">&quot; in standalone mode&quot;</span>);</span><br><span class="line">        <span class="comment">// there is only server in the quorum -- run as standalone</span></span><br><span class="line">        <span class="comment">// 单机启动</span></span><br><span class="line">        ZooKeeperServerMain.main(args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>预启动流程如下</p>
<ul>
<li>初始化<code>QuorumPeerMain</code></li>
<li>解析配置文件<code>zoo.cfg</code></li>
<li>创建并启动历史文件清理器<code>DatadirCleanupManager</code></li>
<li>判断单机/集群模式</li>
<li>如果集群模式，以集群模式读取配置文件并启动</li>
<li>如果是单机模式，初始化<code>ZooKeeperServerMain</code></li>
</ul>
<h2 id="创建并启动DatadirCleanupManager"><a href="#创建并启动DatadirCleanupManager" class="headerlink" title="创建并启动DatadirCleanupManager"></a>创建并启动DatadirCleanupManager</h2><p>读取配置文件就不看了，看下<code>DatadirCleanupManager</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DatadirCleanupManager</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">DatadirCleanupManager</span><span class="params">(String snapDir, String dataLogDir, <span class="keyword">int</span> snapRetainCount,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> purgeInterval)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.snapDir = snapDir;</span><br><span class="line">    <span class="keyword">this</span>.dataLogDir = dataLogDir;</span><br><span class="line">    <span class="keyword">this</span>.snapRetainCount = snapRetainCount;</span><br><span class="line">    <span class="keyword">this</span>.purgeInterval = purgeInterval;</span><br><span class="line">    LOG.info(<span class="string">&quot;autopurge.snapRetainCount set to &quot;</span> + snapRetainCount);</span><br><span class="line">    LOG.info(<span class="string">&quot;autopurge.purgeInterval set to &quot;</span> + purgeInterval);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// DatadirCleanupManager#start()</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (PurgeTaskStatus.STARTED == purgeTaskStatus) &#123;</span><br><span class="line">        LOG.warn(<span class="string">&quot;Purge task is already running.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Don&#x27;t schedule the purge task with zero or negative purge interval.</span></span><br><span class="line">    <span class="comment">// 值小于等于0表示不开启定时清理功能</span></span><br><span class="line">    <span class="keyword">if</span> (purgeInterval &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        LOG.info(<span class="string">&quot;Purge task is not scheduled.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    timer = <span class="keyword">new</span> Timer(<span class="string">&quot;PurgeTask&quot;</span>, <span class="keyword">true</span>);</span><br><span class="line">    TimerTask task = <span class="keyword">new</span> PurgeTask(dataLogDir, snapDir, snapRetainCount);</span><br><span class="line">    <span class="comment">// 单位小时，源码中写死的</span></span><br><span class="line">    timer.scheduleAtFixedRate(task, <span class="number">0</span>, TimeUnit.HOURS.toMillis(purgeInterval));</span><br><span class="line"></span><br><span class="line">    purgeTaskStatus = PurgeTaskStatus.STARTED;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这几个构造参数说下</p>
<ul>
<li>snapDir:快照目录，zoo.cfg中的<code>dataDir</code>属性</li>
<li>dataLogDir:事务日志目录，zoo.cfg中的<code>dataLDir</code>属性</li>
<li>snapRetainCount:清除后要保留的快照数，zoo.cfg中的<code>autopurge.snapRetainCount</code>属性，最小为3</li>
<li>purgeInterval:定时清理的时间间隔，zoo.cfg中的<code>autopurge.purgeInterval</code>属性，默认值0，单位小时，值小于等于0表示不开启定时清理功能，这里的定时是以<code>FixedRate</code>方式，即不管你上次执没执行完，到时间点就得开始下次定时任务了</li>
</ul>
<h1 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ZooKeeperServerMain#main()</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    ZooKeeperServerMain main = <span class="keyword">new</span> ZooKeeperServerMain();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        main.initializeAndRun(args);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    LOG.info(<span class="string">&quot;Exiting normally&quot;</span>);</span><br><span class="line">    System.exit(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ZooKeeperServerMain#initializeAndRun()</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initializeAndRun</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ConfigException, IOException</span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 设置日志相关配置</span></span><br><span class="line">        ManagedUtil.registerLog4jMBeans();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (JMException e) &#123;</span><br><span class="line">        LOG.warn(<span class="string">&quot;Unable to register log4j JMX control&quot;</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 再次解析zoo.cfg配置文件</span></span><br><span class="line">    ServerConfig config = <span class="keyword">new</span> ServerConfig();</span><br><span class="line">    <span class="keyword">if</span> (args.length == <span class="number">1</span>) &#123;</span><br><span class="line">        config.parse(args[<span class="number">0</span>]);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        config.parse(args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    runFromConfig(config);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这段代码也简单，初始化<code>ZooKeeperServerMain</code>，然后设置日志配置，然后再次读取配置文件，然后就是正式的启动了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ZooKeeperServerMain#runFromConfig()</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">runFromConfig</span><span class="params">(ServerConfig config)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    LOG.info(<span class="string">&quot;Starting server&quot;</span>);</span><br><span class="line">    FileTxnSnapLog txnLog = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// Note that this thread isn&#x27;t going to be doing anything else,</span></span><br><span class="line">        <span class="comment">// so rather than spawning another thread, we will just call</span></span><br><span class="line">        <span class="comment">// run() in this thread.</span></span><br><span class="line">        <span class="comment">// create a file logger url from the command line args</span></span><br><span class="line">        <span class="keyword">final</span> ZooKeeperServer zkServer = <span class="keyword">new</span> ZooKeeperServer();</span><br><span class="line">        <span class="comment">// Registers shutdown handler which will be used to know the</span></span><br><span class="line">        <span class="comment">// server error or shutdown state changes.</span></span><br><span class="line">        <span class="keyword">final</span> CountDownLatch shutdownLatch = <span class="keyword">new</span> CountDownLatch(<span class="number">1</span>);</span><br><span class="line">        <span class="comment">// 注册Shutdown控制处理器</span></span><br><span class="line">        zkServer.registerServerShutdownHandler(</span><br><span class="line">                <span class="keyword">new</span> ZooKeeperServerShutdownHandler(shutdownLatch));</span><br><span class="line">        <span class="comment">// config.dataLogDir作为dataDir，存储事务日志</span></span><br><span class="line">        <span class="comment">// config.dataDir作为snapDir，存储快照文件</span></span><br><span class="line">        txnLog = <span class="keyword">new</span> FileTxnSnapLog(<span class="keyword">new</span> File(config.dataLogDir), <span class="keyword">new</span> File(</span><br><span class="line">                config.dataDir));</span><br><span class="line">        txnLog.setServerStats(zkServer.serverStats());</span><br><span class="line">        zkServer.setTxnLogFactory(txnLog);</span><br><span class="line">        zkServer.setTickTime(config.tickTime);</span><br><span class="line">        zkServer.setMinSessionTimeout(config.minSessionTimeout);</span><br><span class="line">        zkServer.setMaxSessionTimeout(config.maxSessionTimeout);</span><br><span class="line">        cnxnFactory = ServerCnxnFactory.createFactory();</span><br><span class="line">        cnxnFactory.configure(config.getClientPortAddress(),</span><br><span class="line">                config.getMaxClientCnxns());</span><br><span class="line">        cnxnFactory.startup(zkServer);</span><br><span class="line">        <span class="comment">// Watch status of ZooKeeper server. It will do a graceful shutdown</span></span><br><span class="line">        <span class="comment">// if the server is not running or hits an internal error.</span></span><br><span class="line">        shutdownLatch.await();</span><br><span class="line">        shutdown();</span><br><span class="line"></span><br><span class="line">        cnxnFactory.join();</span><br><span class="line">        <span class="keyword">if</span> (zkServer.canShutdown()) &#123;</span><br><span class="line">            zkServer.shutdown(<span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        <span class="comment">// warn, but generally this is ok</span></span><br><span class="line">        LOG.warn(<span class="string">&quot;Server interrupted&quot;</span>, e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (txnLog != <span class="keyword">null</span>) &#123;</span><br><span class="line">            txnLog.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这段代码做的事情很多，先看初始化<code>ZooKeeperServer</code></p>
<h2 id="初始化ZooKeeperServer"><a href="#初始化ZooKeeperServer" class="headerlink" title="初始化ZooKeeperServer"></a>初始化ZooKeeperServer</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ZooKeeperServer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    serverStats = <span class="keyword">new</span> ServerStats(<span class="keyword">this</span>);</span><br><span class="line">    listener = <span class="keyword">new</span> ZooKeeperServerListenerImpl(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="初始化ServerStats"><a href="#初始化ServerStats" class="headerlink" title="初始化ServerStats"></a>初始化ServerStats</h2><p><code>ServerStats</code>是zookeeper服务端运行时的统计器，包含最基本的运行时信息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServerStats</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 从zookeeper服务端启动开始或最近一次重置服务端统计数据之后</span></span><br><span class="line">    <span class="comment">// 服务端向客户端发送的响应包数量</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> packetsSent;</span><br><span class="line">    <span class="comment">// 从zookeeper服务端启动开始或最近一次重置服务端统计数据之后</span></span><br><span class="line">    <span class="comment">// 服务端接收来自客户端的请求包数量</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> packetsReceived;</span><br><span class="line">    <span class="comment">// 从zookeeper服务端启动开始或最近一次重置服务端统计数据之</span></span><br><span class="line">    <span class="comment">// 服务端处理请求的最大耗时</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> maxLatency;</span><br><span class="line">    <span class="comment">// 从zookeeper服务端启动开始或最近一次重置服务端统计数据之</span></span><br><span class="line">    <span class="comment">// 服务端处理请求的最小耗时</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> minLatency = Long.MAX_VALUE;</span><br><span class="line">    <span class="comment">// 从zookeeper服务端启动开始或最近一次重置服务端统计数据之</span></span><br><span class="line">    <span class="comment">// 服务端处理请求的总耗时</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> totalLatency = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 从zookeeper服务端启动开始或最近一次重置服务端统计数据之</span></span><br><span class="line">    <span class="comment">// 服务端处理客户端请求的总数</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> count = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> AtomicLong fsyncThresholdExceedCount = <span class="keyword">new</span> AtomicLong(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 统计信息的提供者，这里就是ZooKeeperServer</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Provider provider;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="初始化监听器ZooKeeperServerListener"><a href="#初始化监听器ZooKeeperServerListener" class="headerlink" title="初始化监听器ZooKeeperServerListener"></a>初始化监听器ZooKeeperServerListener</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ZooKeeperServerListener</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ZooKeeperServerListenerImpl</span> <span class="keyword">implements</span> <span class="title">ZooKeeperServerListener</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOG = LoggerFactory</span><br><span class="line">            .getLogger(ZooKeeperServerListenerImpl.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ZooKeeperServer zkServer;</span><br><span class="line"></span><br><span class="line">    ZooKeeperServerListenerImpl(ZooKeeperServer zkServer) &#123;</span><br><span class="line">        <span class="keyword">this</span>.zkServer = zkServer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notifyStopping</span><span class="params">(String threadName, <span class="keyword">int</span> exitCode)</span> </span>&#123;</span><br><span class="line">        LOG.info(<span class="string">&quot;Thread &#123;&#125; exits, error code &#123;&#125;&quot;</span>, threadName, exitCode);</span><br><span class="line">        zkServer.setState(State.ERROR);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个zookeeper监听器的默认实现<code>ZooKeeperServerListenerImpl</code>作用就是在关键线程出现致命错误而意外停止时，将zkServer标记为错误状态。也就是用于通知内部错误。</p>
<h2 id="注册shutdown控制器"><a href="#注册shutdown控制器" class="headerlink" title="注册shutdown控制器"></a>注册shutdown控制器</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ZooKeeperServerMain#runFromConfig()</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">runFromConfig</span><span class="params">(ServerConfig config)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    LOG.info(<span class="string">&quot;Starting server&quot;</span>);</span><br><span class="line">    FileTxnSnapLog txnLog = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// Registers shutdown handler which will be used to know the</span></span><br><span class="line">        <span class="comment">// server error or shutdown state changes.</span></span><br><span class="line">        <span class="keyword">final</span> CountDownLatch shutdownLatch = <span class="keyword">new</span> CountDownLatch(<span class="number">1</span>);</span><br><span class="line">        <span class="comment">// 注册Shutdown控制处理器</span></span><br><span class="line">        zkServer.registerServerShutdownHandler(</span><br><span class="line">                <span class="keyword">new</span> ZooKeeperServerShutdownHandler(shutdownLatch));</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line">        cnxnFactory.startup(zkServer);</span><br><span class="line">        <span class="comment">// Watch status of ZooKeeper server. It will do a graceful shutdown</span></span><br><span class="line">        <span class="comment">// if the server is not running or hits an internal error.</span></span><br><span class="line">        shutdownLatch.await();</span><br><span class="line">        shutdown();</span><br><span class="line"></span><br><span class="line">        cnxnFactory.join();</span><br><span class="line">        <span class="keyword">if</span> (zkServer.canShutdown()) &#123;</span><br><span class="line">            zkServer.shutdown(<span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        <span class="comment">// warn, but generally this is ok</span></span><br><span class="line">        LOG.warn(<span class="string">&quot;Server interrupted&quot;</span>, e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (txnLog != <span class="keyword">null</span>) &#123;</span><br><span class="line">            txnLog.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ZooKeeperServerShutdownHandler</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ZooKeeperServerShutdownHandler</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CountDownLatch shutdownLatch;</span><br><span class="line"></span><br><span class="line">    ZooKeeperServerShutdownHandler(CountDownLatch shutdownLatch) &#123;</span><br><span class="line">        <span class="keyword">this</span>.shutdownLatch = shutdownLatch;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * This will be invoked when the server transition to a new server state.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> state new server state</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">// 在zkServer运行状态改变后会调用该方法，如果出现error或者要关闭，就会countDown操作，上边阻塞在shutdownLatch.await();的操作就会继续往下走，执行服务关闭</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">handle</span><span class="params">(State state)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (state == State.ERROR || state == State.SHUTDOWN) &#123;</span><br><span class="line">            shutdownLatch.countDown();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里<code>shutdownLatch</code>的作用就是观察ZooKeeper服务器的状态，如果服务器未运行或遇到内部错误，它将执行正常关闭。</p>
<h2 id="初始化数据管理器FileTxnSnapLog"><a href="#初始化数据管理器FileTxnSnapLog" class="headerlink" title="初始化数据管理器FileTxnSnapLog"></a>初始化数据管理器FileTxnSnapLog</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// config.dataLogDir作为dataDir，存储事务日志</span></span><br><span class="line"><span class="comment">// config.dataDir作为snapDir，存储快照文件</span></span><br><span class="line"><span class="comment">// FileTxnSnapLog</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">FileTxnSnapLog</span><span class="params">(File dataDir, File snapDir)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    LOG.debug(<span class="string">&quot;Opening datadir:&#123;&#125; snapDir:&#123;&#125;&quot;</span>, dataDir, snapDir);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.dataDir = <span class="keyword">new</span> File(dataDir, version + VERSION);</span><br><span class="line">    <span class="keyword">this</span>.snapDir = <span class="keyword">new</span> File(snapDir, version + VERSION);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.dataDir.exists()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>.dataDir.mkdirs()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;Unable to create data directory &quot;</span></span><br><span class="line">                    + <span class="keyword">this</span>.dataDir);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.dataDir.canWrite()) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;Cannot write to data directory &quot;</span> + <span class="keyword">this</span>.dataDir);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.snapDir.exists()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>.snapDir.mkdirs()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;Unable to create snap directory &quot;</span></span><br><span class="line">                    + <span class="keyword">this</span>.snapDir);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.snapDir.canWrite()) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;Cannot write to snap directory &quot;</span> + <span class="keyword">this</span>.snapDir);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// check content of transaction log and snapshot dirs if they are two different directories</span></span><br><span class="line">    <span class="comment">// See ZOOKEEPER-2967 for more details</span></span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">this</span>.dataDir.getPath().equals(<span class="keyword">this</span>.snapDir.getPath()))&#123;</span><br><span class="line">        checkLogDir();</span><br><span class="line">        checkSnapDir();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    txnLog = <span class="keyword">new</span> FileTxnLog(<span class="keyword">this</span>.dataDir);</span><br><span class="line">    snapLog = <span class="keyword">new</span> FileSnap(<span class="keyword">this</span>.snapDir);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>FileTxnSnapLog</code>是zookeeper上层服务器和底层数据存储的对接层，提供了操作数据文件的接口。zoo.cfg中的<code>dataLogDir</code>会作为事务日志目录，<code>dataDir</code>会作为快照目录。</p>
<h2 id="组装ZooKeeperServer实例"><a href="#组装ZooKeeperServer实例" class="headerlink" title="组装ZooKeeperServer实例"></a>组装ZooKeeperServer实例</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">runFromConfig</span><span class="params">(ServerConfig config)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    txnLog.setServerStats(zkServer.serverStats());</span><br><span class="line">    zkServer.setTxnLogFactory(txnLog);</span><br><span class="line">    zkServer.setTickTime(config.tickTime);</span><br><span class="line">    zkServer.setMinSessionTimeout(config.minSessionTimeout);</span><br><span class="line">    zkServer.setMaxSessionTimeout(config.maxSessionTimeout);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里就是将刚才初始化的数据管理器<code>FileTxnSnapLog</code>实例交付到<code>ZooKeeperServer</code>实例，然后设置心跳间隔和会话超时时间</p>
<h2 id="工厂创建ServerCnxnFactory"><a href="#工厂创建ServerCnxnFactory" class="headerlink" title="工厂创建ServerCnxnFactory"></a>工厂创建ServerCnxnFactory</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">public</span> ServerCnxnFactory <span class="title">createFactory</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    String serverCnxnFactoryName =</span><br><span class="line">        System.getProperty(ZOOKEEPER_SERVER_CNXN_FACTORY);</span><br><span class="line">    <span class="keyword">if</span> (serverCnxnFactoryName == <span class="keyword">null</span>) &#123;</span><br><span class="line">        serverCnxnFactoryName = NIOServerCnxnFactory.class.getName();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ServerCnxnFactory serverCnxnFactory = (ServerCnxnFactory) Class.forName(serverCnxnFactoryName)</span><br><span class="line">                .getDeclaredConstructor().newInstance();</span><br><span class="line">        LOG.info(<span class="string">&quot;Using &#123;&#125; as server connection factory&quot;</span>, serverCnxnFactoryName);</span><br><span class="line">        <span class="keyword">return</span> serverCnxnFactory;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        IOException ioe = <span class="keyword">new</span> IOException(<span class="string">&quot;Couldn&#x27;t instantiate &quot;</span></span><br><span class="line">                + serverCnxnFactoryName);</span><br><span class="line">        ioe.initCause(e);</span><br><span class="line">        <span class="keyword">throw</span> ioe;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>反射创建<code>ServerCnxnFactory</code>实例，这里可以通过配置<code>zookeeper.serverCnxnFactory</code>属性来设置使用zookeeper自己实现的nio还是使用netty框架作为zookeeper服务端网络连接工厂。</p>
<h2 id="初始化ServerCnxnFactory"><a href="#初始化ServerCnxnFactory" class="headerlink" title="初始化ServerCnxnFactory"></a>初始化ServerCnxnFactory</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ZooKeeperServerMain#runFromConfig()</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">runFromConfig</span><span class="params">(ServerConfig config)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    cnxnFactory.configure(config.getClientPortAddress(), config.getMaxClientCnxns());</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// NIOServerCnxnFactory#configure()</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(InetSocketAddress addr, <span class="keyword">int</span> maxcc)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">// SASL权限验证</span></span><br><span class="line">    configureSaslLogin();</span><br><span class="line">    <span class="comment">// 初始化Thread作为NIOServerCnxnFactory的主线程</span></span><br><span class="line">    thread = <span class="keyword">new</span> ZooKeeperThread(<span class="keyword">this</span>, <span class="string">&quot;NIOServerCxn.Factory:&quot;</span> + addr);</span><br><span class="line">    thread.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">    <span class="comment">// 设置客户端最大连接数</span></span><br><span class="line">    maxClientCnxns = maxcc;</span><br><span class="line">    <span class="comment">// 设置ServerSocketChannel</span></span><br><span class="line">    <span class="keyword">this</span>.ss = ServerSocketChannel.open();</span><br><span class="line">    ss.socket().setReuseAddress(<span class="keyword">true</span>);</span><br><span class="line">    LOG.info(<span class="string">&quot;binding to port &quot;</span> + addr);</span><br><span class="line">    ss.socket().bind(addr);</span><br><span class="line">    ss.configureBlocking(<span class="keyword">false</span>);</span><br><span class="line">    ss.register(selector, SelectionKey.OP_ACCEPT);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="启动NIOServerCnxnFactory主线程"><a href="#启动NIOServerCnxnFactory主线程" class="headerlink" title="启动NIOServerCnxnFactory主线程"></a>启动NIOServerCnxnFactory主线程</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ZooKeeperServerMain#runFromConfig()</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">runFromConfig</span><span class="params">(ServerConfig config)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    cnxnFactory.startup(zkServer);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// NIOServerCnxnFactory#startup()</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startup</span><span class="params">(ZooKeeperServer zks)</span> <span class="keyword">throws</span> IOException,</span></span><br><span class="line"><span class="function">        InterruptedException </span>&#123;</span><br><span class="line">    <span class="comment">// 开启上面初始化的ZooKeeperThread主线程</span></span><br><span class="line">    start();</span><br><span class="line">    <span class="comment">// 将zookeeper服务与ServerCnxnFactory绑定</span></span><br><span class="line">    setZooKeeperServer(zks);</span><br><span class="line">    <span class="comment">// 恢复本地数据</span></span><br><span class="line">    zks.startdata();</span><br><span class="line">    zks.startup();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// NIOServerCnxnFactory#start()</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ensure thread is started once and only once</span></span><br><span class="line">    <span class="comment">// 确保线程会且仅会启动一次</span></span><br><span class="line">    <span class="keyword">if</span> (thread.getState() == Thread.State.NEW) &#123;</span><br><span class="line">        <span class="comment">// 启动ZooKeeperThread线程</span></span><br><span class="line">        thread.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在NIOServerCnxnFactory主线程开始后，zookeeper已经可以作为nio服务器对外开放端口，但是客户端并不能通过2181端口访问服务。为什么？因为 <strong>zookeeper服务与ServerCnxnFactory没有进行绑定</strong> ，就算有请求通过2181进来，也找不到上层zookeeper服务。所以接下来就是绑定。</p>
<h2 id="ServerCnxnFactory与ZooKeeperServer绑定"><a href="#ServerCnxnFactory与ZooKeeperServer绑定" class="headerlink" title="ServerCnxnFactory与ZooKeeperServer绑定"></a>ServerCnxnFactory与ZooKeeperServer绑定</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ServerCnxnFactory#setZooKeeperServer()</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setZooKeeperServer</span><span class="params">(ZooKeeperServer zk)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.zkServer = zk;</span><br><span class="line">    <span class="keyword">if</span> (zk != <span class="keyword">null</span>) &#123;</span><br><span class="line">        zk.setServerCnxnFactory(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看出这里<code>ZooKeeperServer</code>和<code>ServerCnxnFactory</code>是 <strong>双向绑定</strong> 关系</p>
<h2 id="恢复本地数据"><a href="#恢复本地数据" class="headerlink" title="恢复本地数据"></a>恢复本地数据</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ZooKeeperServer#startdata()</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startdata</span><span class="params">()</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">    <span class="comment">//check to see if zkDb is not null</span></span><br><span class="line">    <span class="keyword">if</span> (zkDb == <span class="keyword">null</span>) &#123;</span><br><span class="line">        zkDb = <span class="keyword">new</span> ZKDatabase(<span class="keyword">this</span>.txnLogFactory);</span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">if</span> (!zkDb.isInitialized()) &#123;</span><br><span class="line">        loadData();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ZooKeeperServer#loadData()</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadData</span><span class="params">()</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * When a new leader starts executing Leader#lead, it</span></span><br><span class="line"><span class="comment">     * invokes this method. The database, however, has been</span></span><br><span class="line"><span class="comment">     * initialized before running leader election so that</span></span><br><span class="line"><span class="comment">     * the server could pick its zxid for its initial vote.</span></span><br><span class="line"><span class="comment">     * It does it by invoking QuorumPeer#getLastLoggedZxid.</span></span><br><span class="line"><span class="comment">     * Consequently, we don&#x27;t need to initialize it once more</span></span><br><span class="line"><span class="comment">     * and avoid the penalty of loading it a second time. Not</span></span><br><span class="line"><span class="comment">     * reloading it is particularly important for applications</span></span><br><span class="line"><span class="comment">     * that host a large database.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * The following if block checks whether the database has</span></span><br><span class="line"><span class="comment">     * been initialized or not. Note that this method is</span></span><br><span class="line"><span class="comment">     * invoked by at least one other method:</span></span><br><span class="line"><span class="comment">     * ZooKeeperServer#startdata.</span></span><br><span class="line"><span class="comment">     *  </span></span><br><span class="line"><span class="comment">     * See ZOOKEEPER-1642 for more detail.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span>(zkDb.isInitialized())&#123;</span><br><span class="line">        setZxid(zkDb.getDataTreeLastProcessedZxid());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        setZxid(zkDb.loadDataBase());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Clean up dead sessions</span></span><br><span class="line">    LinkedList&lt;Long&gt; deadSessions = <span class="keyword">new</span> LinkedList&lt;Long&gt;();</span><br><span class="line">    <span class="keyword">for</span> (Long session : zkDb.getSessions()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (zkDb.getSessionWithTimeOuts().get(session) == <span class="keyword">null</span>) &#123;</span><br><span class="line">            deadSessions.add(session);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    zkDb.setDataTreeInit(<span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">long</span> session : deadSessions) &#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">XXX:</span> Is lastProcessedZxid really the best thing to use?</span></span><br><span class="line">        killSession(session, zkDb.getDataTreeLastProcessedZxid());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ZKDatabase#loadDataBase()</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">loadDataBase</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> zxid = snapLog.restore(dataTree, sessionsWithTimeouts, commitProposalPlaybackListener);</span><br><span class="line">    initialized = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">return</span> zxid;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里面在恢复数据的时候会先看内存数据库<code>ZKDatabase</code>是否为空，为空就构造实例。不为空就检查是否初始化，没有初始化就<code>loadData</code>。没有初始化，就从快照中恢复数据，然后标记初始化，获得最新的zxid。内存数据库启动之后，就会筛除失效的会话，并且关闭它们。<br>底层的内存数据库启动之后就要启动上层的一些东西了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ZooKeeperServer#startup()</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">startup</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 创建会话管理器</span></span><br><span class="line">    <span class="keyword">if</span> (sessionTracker == <span class="keyword">null</span>) &#123;</span><br><span class="line">        createSessionTracker();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 启动会话管理器</span></span><br><span class="line">    startSessionTracker();</span><br><span class="line">    <span class="comment">// 启动处理器链</span></span><br><span class="line">    setupRequestProcessors();</span><br><span class="line">    <span class="comment">// 注册JMX服务</span></span><br><span class="line">    registerJMX();</span><br><span class="line">    <span class="comment">// 标记运行</span></span><br><span class="line">    setState(State.RUNNING);</span><br><span class="line">    <span class="comment">// 唤醒阻塞的线程，防止死锁</span></span><br><span class="line">    notifyAll();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="创建会话管理器SessionTracker"><a href="#创建会话管理器SessionTracker" class="headerlink" title="创建会话管理器SessionTracker"></a>创建会话管理器SessionTracker</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ZooKeeperServer#createSessionTracker()</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">createSessionTracker</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    sessionTracker = <span class="keyword">new</span> SessionTrackerImpl(<span class="keyword">this</span>, zkDb.getSessionWithTimeOuts(),</span><br><span class="line">            tickTime, <span class="number">1</span>, getZooKeeperServerListener());</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">SessionTrackerImpl</span><span class="params">(SessionExpirer expirer, ConcurrentHashMap&lt;Long, Integer&gt; sessionsWithTimeout, <span class="keyword">int</span> tickTime, <span class="keyword">long</span> sid, ZooKeeperServerListener listener)</span>  </span>&#123;</span><br><span class="line">    <span class="comment">// 设置监听器</span></span><br><span class="line">    <span class="keyword">super</span>(<span class="string">&quot;SessionTracker&quot;</span>, listener);</span><br><span class="line">    <span class="keyword">this</span>.expirer = expirer;</span><br><span class="line">    <span class="keyword">this</span>.expirationInterval = tickTime;</span><br><span class="line">    <span class="keyword">this</span>.sessionsWithTimeout = sessionsWithTimeout;</span><br><span class="line">    <span class="comment">// 分桶策略的key</span></span><br><span class="line">    nextExpirationTime = roundToInterval(Time.currentElapsedTime());</span><br><span class="line">    <span class="comment">// 初始化基准sessionId</span></span><br><span class="line">    <span class="keyword">this</span>.nextSessionId = initializeNextSession(sid);</span><br><span class="line">    <span class="comment">// 加载会话</span></span><br><span class="line">    <span class="keyword">for</span> (Entry&lt;Long, Integer&gt; e : sessionsWithTimeout.entrySet()) &#123;</span><br><span class="line">        addSession(e.getKey(), e.getValue());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="启动会话管理器SessionTracker"><a href="#启动会话管理器SessionTracker" class="headerlink" title="启动会话管理器SessionTracker"></a>启动会话管理器SessionTracker</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ZooKeeperServer#startSessionTracker()</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">startSessionTracker</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ((SessionTrackerImpl)sessionTracker).start();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// SessionTrackerImpl#run()</span></span><br><span class="line"><span class="function"><span class="keyword">synchronized</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (running) &#123;</span><br><span class="line">            currentTime = Time.currentElapsedTime();</span><br><span class="line">            <span class="keyword">if</span> (nextExpirationTime &gt; currentTime) &#123;</span><br><span class="line">                <span class="keyword">this</span>.wait(nextExpirationTime - currentTime);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            SessionSet set;</span><br><span class="line">            set = sessionSets.remove(nextExpirationTime);</span><br><span class="line">            <span class="keyword">if</span> (set != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (SessionImpl s : set.sessions) &#123;</span><br><span class="line">                    setSessionClosing(s.sessionId);</span><br><span class="line">                    expirer.expire(s);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            nextExpirationTime += expirationInterval;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        handleException(<span class="keyword">this</span>.getName(), e);</span><br><span class="line">    &#125;</span><br><span class="line">    LOG.info(<span class="string">&quot;SessionTrackerImpl exited loop!&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>之前见过这段代码，定期(tickTime)从桶里批量清理会话</p>
<h2 id="初始化处理器链"><a href="#初始化处理器链" class="headerlink" title="初始化处理器链"></a>初始化处理器链</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ZooKeeperServer#setupRequestProcessors()</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">setupRequestProcessors</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    RequestProcessor finalProcessor = <span class="keyword">new</span> FinalRequestProcessor(<span class="keyword">this</span>);</span><br><span class="line">    RequestProcessor syncProcessor = <span class="keyword">new</span> SyncRequestProcessor(<span class="keyword">this</span>,</span><br><span class="line">            finalProcessor);</span><br><span class="line">    ((SyncRequestProcessor)syncProcessor).start();</span><br><span class="line">    firstProcessor = <span class="keyword">new</span> PrepRequestProcessor(<span class="keyword">this</span>, syncProcessor);</span><br><span class="line">    ((PrepRequestProcessor)firstProcessor).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里是单机模式的启动，所以处理器链简单,就三个:<br><code>PrepRequestProcessor -&gt; SyncRequestProcessor -&gt; FinalRequestProcessor</code></p>
<h2 id="注册JMX服务"><a href="#注册JMX服务" class="headerlink" title="注册JMX服务"></a>注册JMX服务</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ZooKeeperServer#registerJMX()</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">registerJMX</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// register with JMX</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        jmxServerBean = <span class="keyword">new</span> ZooKeeperServerBean(<span class="keyword">this</span>);</span><br><span class="line">        MBeanRegistry.getInstance().register(jmxServerBean, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            jmxDataTreeBean = <span class="keyword">new</span> DataTreeBean(zkDb.getDataTree());</span><br><span class="line">            MBeanRegistry.getInstance().register(jmxDataTreeBean, jmxServerBean);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            LOG.warn(<span class="string">&quot;Failed to register with JMX&quot;</span>, e);</span><br><span class="line">            jmxDataTreeBean = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        LOG.warn(<span class="string">&quot;Failed to register with JMX&quot;</span>, e);</span><br><span class="line">        jmxServerBean = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里会将<code>ZooKeeperServer</code>和<code>DataTree</code>以JMX方式暴露给外部查看信息</p>
<h2 id="设置运行状态"><a href="#设置运行状态" class="headerlink" title="设置运行状态"></a>设置运行状态</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ZooKeeperServer#setState()</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">setState</span><span class="params">(State state)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.state = state;</span><br><span class="line">    <span class="comment">// Notify server state changes to the registered shutdown handler, if any.</span></span><br><span class="line">    <span class="keyword">if</span> (zkShutdownHandler != <span class="keyword">null</span>) &#123;</span><br><span class="line">        zkShutdownHandler.handle(state);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        LOG.debug(<span class="string">&quot;ZKShutdownHandler is not registered, so ZooKeeper server &quot;</span></span><br><span class="line">                + <span class="string">&quot;won&#x27;t take any action on ERROR or SHUTDOWN server state changes&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里由于<code>RUNNING</code>状态，所以<code>handle</code>方法内不会处理<br>单机启动流程完成！</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2018/09/03/zookeeper%E5%8D%95%E6%9C%BA%E6%9C%8D%E5%8A%A1%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/" data-id="ckjr4ve0t008zf0ukhuz35eh2" data-title="zookeeper单机服务启动流程" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/zookeeper/" rel="tag">zookeeper</a></li></ul>

    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><a class="extend next" rel="next" href="/page/3/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/activemq/">activemq</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/">hadoop</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/js/">js</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/jvm/">jvm</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/maven/">maven</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/mysql/">mysql</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/spring/">spring</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/zookeeper/">zookeeper</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%A4%9A%E7%BA%BF%E7%A8%8B/">多线程</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%97%A5%E5%BF%97/">日志</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%AE%97%E6%B3%95/">算法</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%BD%AE%E5%AD%90/">轮子</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%80%9A%E8%AF%86/">通识</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/CountDownLatch/" rel="tag">CountDownLatch</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CyclicBarrier/" rel="tag">CyclicBarrier</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ReentrantLock/" rel="tag">ReentrantLock</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ReentrantReadWriteLock/" rel="tag">ReentrantReadWriteLock</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ThreadLocal/" rel="tag">ThreadLocal</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/activemq/" rel="tag">activemq</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cas%E6%93%8D%E4%BD%9C/" rel="tag">cas操作</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cron/" rel="tag">cron</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/fork-join%E6%A1%86%E6%9E%B6/" rel="tag">fork/join框架</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/freemark/" rel="tag">freemark</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hadoop/" rel="tag">hadoop</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/js/" rel="tag">js</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jvm/" rel="tag">jvm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jvm%EF%BC%8C%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/" rel="tag">jvm，垃圾回收</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/" rel="tag">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/log4j/" rel="tag">log4j</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/maven/" rel="tag">maven</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mysql/" rel="tag">mysql</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/protobuf/" rel="tag">protobuf</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/quartz/" rel="tag">quartz</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/redis/" rel="tag">redis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/servlet3/" rel="tag">servlet3</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/spring/" rel="tag">spring</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/springboot/" rel="tag">springboot</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tomcat/" rel="tag">tomcat</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/web-xml/" rel="tag">web.xml</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/zookeeper/" rel="tag">zookeeper</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/" rel="tag">主从复制</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F/" rel="tag">单例模式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%9F%BA%E7%A1%80%E7%BA%BF%E7%A8%8B%E6%B1%A0/" rel="tag">基础线程池</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" rel="tag">多线程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AD%97%E7%AC%A6%E4%B8%B2/" rel="tag">字符串</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8/" rel="tag">布隆过滤器</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B9%B6%E5%8F%91%E9%9B%86%E5%90%88%E7%B1%BB/" rel="tag">并发集合类</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%90%9C%E7%B4%A2/" rel="tag">搜索</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E5%AD%97%E6%A0%BC%E5%BC%8F%E5%8C%96/" rel="tag">数字格式化</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%97%A0%E9%94%81/" rel="tag">无锁</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%97%A5%E6%9C%9F%E6%A0%BC%E5%BC%8F%E5%8C%96/" rel="tag">日期格式化</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%A0%88/" rel="tag">栈</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%B3%9B%E5%9E%8B/" rel="tag">泛型</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BA%BF%E7%A8%8B%E6%B1%A0/" rel="tag">线程池</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BA%BF%E7%A8%8B%E9%98%BB%E5%A1%9E%E5%B7%A5%E5%85%B7/" rel="tag">线程阻塞工具</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%BD%AE%E5%AD%90/" rel="tag">轮子</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%80%9A%E8%AF%86/" rel="tag">通识</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%94%81%E4%BC%98%E5%8C%96/" rel="tag">锁优化</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%98%9F%E5%88%97/" rel="tag">队列</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/CountDownLatch/" style="font-size: 10px;">CountDownLatch</a> <a href="/tags/CyclicBarrier/" style="font-size: 10px;">CyclicBarrier</a> <a href="/tags/ReentrantLock/" style="font-size: 10px;">ReentrantLock</a> <a href="/tags/ReentrantReadWriteLock/" style="font-size: 10px;">ReentrantReadWriteLock</a> <a href="/tags/ThreadLocal/" style="font-size: 10px;">ThreadLocal</a> <a href="/tags/activemq/" style="font-size: 10px;">activemq</a> <a href="/tags/cas%E6%93%8D%E4%BD%9C/" style="font-size: 10px;">cas操作</a> <a href="/tags/cron/" style="font-size: 10px;">cron</a> <a href="/tags/fork-join%E6%A1%86%E6%9E%B6/" style="font-size: 10px;">fork/join框架</a> <a href="/tags/freemark/" style="font-size: 10px;">freemark</a> <a href="/tags/hadoop/" style="font-size: 12px;">hadoop</a> <a href="/tags/js/" style="font-size: 14px;">js</a> <a href="/tags/jvm/" style="font-size: 10px;">jvm</a> <a href="/tags/jvm%EF%BC%8C%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/" style="font-size: 12px;">jvm，垃圾回收</a> <a href="/tags/linux/" style="font-size: 16px;">linux</a> <a href="/tags/log4j/" style="font-size: 10px;">log4j</a> <a href="/tags/maven/" style="font-size: 10px;">maven</a> <a href="/tags/mysql/" style="font-size: 14px;">mysql</a> <a href="/tags/protobuf/" style="font-size: 10px;">protobuf</a> <a href="/tags/quartz/" style="font-size: 12px;">quartz</a> <a href="/tags/redis/" style="font-size: 10px;">redis</a> <a href="/tags/servlet3/" style="font-size: 10px;">servlet3</a> <a href="/tags/spring/" style="font-size: 12px;">spring</a> <a href="/tags/springboot/" style="font-size: 10px;">springboot</a> <a href="/tags/tomcat/" style="font-size: 10px;">tomcat</a> <a href="/tags/web-xml/" style="font-size: 10px;">web.xml</a> <a href="/tags/zookeeper/" style="font-size: 20px;">zookeeper</a> <a href="/tags/%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/" style="font-size: 10px;">主从复制</a> <a href="/tags/%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F/" style="font-size: 10px;">单例模式</a> <a href="/tags/%E5%9F%BA%E7%A1%80%E7%BA%BF%E7%A8%8B%E6%B1%A0/" style="font-size: 10px;">基础线程池</a> <a href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" style="font-size: 18px;">多线程</a> <a href="/tags/%E5%AD%97%E7%AC%A6%E4%B8%B2/" style="font-size: 10px;">字符串</a> <a href="/tags/%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8/" style="font-size: 10px;">布隆过滤器</a> <a href="/tags/%E5%B9%B6%E5%8F%91%E9%9B%86%E5%90%88%E7%B1%BB/" style="font-size: 10px;">并发集合类</a> <a href="/tags/%E6%90%9C%E7%B4%A2/" style="font-size: 10px;">搜索</a> <a href="/tags/%E6%95%B0%E5%AD%97%E6%A0%BC%E5%BC%8F%E5%8C%96/" style="font-size: 12px;">数字格式化</a> <a href="/tags/%E6%97%A0%E9%94%81/" style="font-size: 10px;">无锁</a> <a href="/tags/%E6%97%A5%E6%9C%9F%E6%A0%BC%E5%BC%8F%E5%8C%96/" style="font-size: 10px;">日期格式化</a> <a href="/tags/%E6%A0%88/" style="font-size: 10px;">栈</a> <a href="/tags/%E6%B3%9B%E5%9E%8B/" style="font-size: 10px;">泛型</a> <a href="/tags/%E7%BA%BF%E7%A8%8B%E6%B1%A0/" style="font-size: 10px;">线程池</a> <a href="/tags/%E7%BA%BF%E7%A8%8B%E9%98%BB%E5%A1%9E%E5%B7%A5%E5%85%B7/" style="font-size: 10px;">线程阻塞工具</a> <a href="/tags/%E8%BD%AE%E5%AD%90/" style="font-size: 10px;">轮子</a> <a href="/tags/%E9%80%9A%E8%AF%86/" style="font-size: 10px;">通识</a> <a href="/tags/%E9%94%81%E4%BC%98%E5%8C%96/" style="font-size: 12px;">锁优化</a> <a href="/tags/%E9%98%9F%E5%88%97/" style="font-size: 10px;">队列</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">January 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">October 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">September 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/01/10/hello-world/">Hello World</a>
          </li>
        
          <li>
            <a href="/2018/12/24/federation%E6%A8%A1%E5%BC%8F%E7%9A%84hadoop%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/">federation模式的hadoop集群搭建</a>
          </li>
        
          <li>
            <a href="/2018/12/16/hadoop%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/">hadoop集群搭建</a>
          </li>
        
          <li>
            <a href="/2018/10/26/linux-%E6%96%87%E4%BB%B6%E7%AE%A1%E7%90%86/">linux-文件管理</a>
          </li>
        
          <li>
            <a href="/2018/10/25/%E6%98%9F%E6%9C%9F%E6%9C%88%E4%BB%BD%E8%8B%B1%E6%96%87%E7%BC%A9%E5%86%99/">星期月份英文缩写</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2021 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>